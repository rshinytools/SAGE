# SAGE Platform - Master Implementation Plan

## Single Source of Truth Documentation

**Version:** 2.0
**Last Updated:** December 2024
**Status:** Active Development

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Platform Architecture](#platform-architecture)
3. [The Four Factories Model](#the-four-factories-model)
4. [Factory 1: Data Foundry](#factory-1-data-foundry)
5. [Factory 2: Metadata Refinery](#factory-2-metadata-refinery)
6. [Factory 3: Dictionary Plant](#factory-3-dictionary-plant)
7. [Factory 4: Inference Engine](#factory-4-inference-engine)
8. [End-to-End Integration](#end-to-end-integration)
9. [Admin UI & Infrastructure](#admin-ui--infrastructure)
10. [Implementation Checklists](#implementation-checklists)
11. [Project Status Summary](#project-status-summary)

---

## Executive Summary

SAGE (Study Analytics Generative Engine) is an on-premise clinical data AI platform that enables natural language queries against SDTM and ADaM clinical trial datasets. The system uses a RAG architecture with local LLMs to translate natural language to SQL/Python code, which is then executed deterministically against DuckDB.

### Core Principle
> **The AI acts as a TRANSLATOR, not an EXPERT.** Mathematical calculations are performed by generated code, not by probabilistic AI inference.

### Key Features
- 100% on-premise deployment (air-gapped capable)
- Natural language to SQL translation
- Confidence scoring with explanations
- Human-in-the-loop metadata approval
- Complete audit trail
- GAMP 5 Category 4 validation approach

### Technology Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| LLM Runtime | Ollama | Local LLM inference |
| Primary Model | DeepSeek-R1 8B | SQL generation, analysis |
| Embeddings | nomic-embed-text | Semantic search |
| SQL Database | DuckDB | Clinical data queries |
| Vector Database | ChromaDB | Fuzzy matching, RAG |
| Backend API | FastAPI | REST API endpoints |
| Frontend | React + TypeScript | Admin UI, Chat UI |
| Containerization | Docker Compose | Service orchestration |

---

## Platform Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SAGE PLATFORM ARCHITECTURE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            USER INTERFACE LAYER                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚     Chat UI         â”‚  â”‚     Admin UI        â”‚  â”‚   Documentation  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Natural Language   â”‚  â”‚  Data Management    â”‚  â”‚   MkDocs Portal  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Query Interface    â”‚  â”‚  Metadata Auditor   â”‚  â”‚                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  (React)            â”‚  â”‚  Project Tracker    â”‚  â”‚                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                         â”‚
â”‚                                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              NGINX API GATEWAY                            â”‚   â”‚
â”‚  â”‚                    Routing | SSL | Rate Limiting | CORS                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                         â”‚
â”‚                                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                             FASTAPI BACKEND                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ /auth/*    â”‚ â”‚ /data/*    â”‚ â”‚ /metadata/*â”‚ â”‚ /chat/*    â”‚            â”‚   â”‚
â”‚  â”‚  â”‚ JWT Auth   â”‚ â”‚ Data Ops   â”‚ â”‚ Metadata   â”‚ â”‚ LLM Query  â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚                                         â”‚
â”‚                                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          THE FOUR FACTORIES                               â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  FACTORY 1  â”‚  â”‚  FACTORY 2  â”‚  â”‚  FACTORY 3  â”‚  â”‚  FACTORY 4  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    Data     â”‚â”€â–¶â”‚  Metadata   â”‚â”€â–¶â”‚ Dictionary  â”‚â”€â–¶â”‚  Inference  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚   Foundry   â”‚  â”‚  Refinery   â”‚  â”‚    Plant    â”‚  â”‚   Engine    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚        â”‚                â”‚                â”‚                â”‚              â”‚   â”‚
â”‚  â”‚        â–¼                â–¼                â–¼                â–¼              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚clinical_dataâ”‚  â”‚golden_meta- â”‚  â”‚ ChromaDB +  â”‚  â”‚   Ollama    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  .duckdb    â”‚  â”‚  data.json  â”‚  â”‚fuzzy_index  â”‚  â”‚ DeepSeek-R1 â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## The Four Factories Model

| Factory | Name | Input | Output | Status |
|---------|------|-------|--------|--------|
| **F1** | Data Foundry | SAS7BDAT, Parquet, CSV | clinical_data.duckdb | âœ… Complete (95%) |
| **F2** | Metadata Refinery | Excel Specifications | golden_metadata.json | âœ… Complete |
| **F2.5** | CDISC Standards | SDTM/ADaM IG Files | cdisc_library.db | âœ… Complete |
| **F3** | Dictionary Plant | DuckDB + Metadata | fuzzy_index.pkl, schema_map.json | âœ… Complete |
| **F3.5** | MedDRA Library | MedDRA ASCII Files | meddra_library.db | âœ… Complete |
| **F4** | Inference Engine | Natural Language Query | SQL + Results + Explanation | ðŸ”„ Basic Implementation |

---

## Factory 1: Data Foundry

### Overview

Factory 1 transforms raw clinical trial data files into a queryable DuckDB database. This is the foundation that all other factories depend on.

### Supported Data Formats

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       SUPPORTED DATA FORMATS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ .sas7bdat   â”‚  â”‚ .parquet    â”‚  â”‚ .csv        â”‚  â”‚ .xpt        â”‚    â”‚
â”‚  â”‚ SAS Dataset â”‚  â”‚ Apache      â”‚  â”‚ Comma       â”‚  â”‚ SAS         â”‚    â”‚
â”‚  â”‚             â”‚  â”‚ Parquet     â”‚  â”‚ Separated   â”‚  â”‚ Transport   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                â”‚                â”‚                â”‚            â”‚
â”‚         â–¼                â–¼                â–¼                â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   UNIVERSAL DATA READER                          â”‚   â”‚
â”‚  â”‚  â€¢ Auto-detect format from extension                             â”‚   â”‚
â”‚  â”‚  â€¢ SAS: encoding detection, date handling                        â”‚   â”‚
â”‚  â”‚  â€¢ Parquet: direct DuckDB load (fastest)                         â”‚   â”‚
â”‚  â”‚  â€¢ CSV: delimiter detection, type inference                      â”‚   â”‚
â”‚  â”‚  â€¢ XPT: SAS transport file support                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      DuckDB Database                             â”‚   â”‚
â”‚  â”‚  Table: DM (from dm.sas7bdat OR dm.parquet OR dm.csv)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  KEY BEHAVIORS:                                                         â”‚
â”‚  âœ“ Same table name regardless of source format (DM from any format)   â”‚
â”‚  âœ“ Replace existing table when re-uploading different format          â”‚
â”‚  âœ“ Track source file metadata (which file, when loaded)               â”‚
â”‚  âœ“ Parquet = fastest (native DuckDB), SAS = full date handling        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Format Comparison

| Format | Processing Speed | Features | Best For |
|--------|-----------------|----------|----------|
| `.parquet` | âš¡ Fastest | Direct load | Pre-processed data, large files |
| `.sas7bdat` | Medium | Date standardization, encoding detection | Original SAS datasets |
| `.csv` | Medium | Delimiter detection, type inference | Universal exchange |
| `.xpt` | Slower | Legacy support | SAS transport files |

### Data Versioning & Schema Evolution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA VERSION CONTROL                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Week 1: Upload dm.sas7bdat                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DM Table (v1)                                                    â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚ â”‚ USUBJID  â”‚ AGE      â”‚ SEX      â”‚ RACE     â”‚ ARM      â”‚        â”‚   â”‚
â”‚  â”‚ â”‚ VARCHAR  â”‚ INTEGER  â”‚ VARCHAR  â”‚ VARCHAR  â”‚ VARCHAR  â”‚        â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚ Source: dm.sas7bdat | Rows: 500 | Created: 2025-01-15           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  Week 2: Upload dm.parquet (different structure)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DM Table (v2) - CURRENT                                         â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚ â”‚ USUBJID  â”‚ AGE      â”‚ SEX      â”‚ ETHNIC   â”‚ ARMCD        â”‚    â”‚   â”‚
â”‚  â”‚ â”‚ VARCHAR  â”‚ DOUBLE   â”‚ VARCHAR  â”‚ VARCHAR  â”‚ VARCHAR      â”‚    â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚ Source: dm.parquet | Rows: 520 | Created: 2025-01-22            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  SCHEMA CHANGES DETECTED:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ AGE: INTEGER â†’ DOUBLE (type change)                           â”‚   â”‚
â”‚  â”‚ â€¢ RACE: removed                                                  â”‚   â”‚
â”‚  â”‚ â€¢ ARM: removed                                                   â”‚   â”‚
â”‚  â”‚ â€¢ ETHNIC: added (new column)                                     â”‚   â”‚
â”‚  â”‚ â€¢ ARMCD: added (new column)                                      â”‚   â”‚
â”‚  â”‚ â€¢ Rows: 500 â†’ 520 (+20)                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  VERSION HISTORY (stored in _sage_data_versions):                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Ver â”‚ Source     â”‚ Date         â”‚ Rows â”‚ Schema Hash         â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ v2  â”‚ dm.parquet â”‚ 2025-01-22   â”‚ 520  â”‚ a8f3c2... (current) â”‚      â”‚
â”‚  â”‚ v1  â”‚ dm.sas7bdatâ”‚ 2025-01-15   â”‚ 500  â”‚ b7e4d1... (archived)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Schema Change Handling

| Scenario | Handling | User Action |
|----------|----------|-------------|
| Same schema, new data | Direct replace | None - automatic |
| New columns added | Replace + log change | Review new columns |
| Columns removed | Replace + **WARNING** | Confirm removal |
| Type change (compatible) | Replace + log (INTâ†’DOUBLE) | Review change |
| Type change (incompatible) | **BLOCK** + require confirmation | Must confirm |
| Major schema change (>30%) | **BLOCK** + show diff | Must review & confirm |

### Data Processing Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA PROCESSING PIPELINE (SSE Streaming)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ Source File â”‚  dm.sas7bdat / dm.parquet / dm.csv                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 1: FORMAT DETECTION                                         â”‚   â”‚
â”‚  â”‚ â€¢ Detect file extension                                          â”‚   â”‚
â”‚  â”‚ â€¢ Route to appropriate reader                                    â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 10%                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 2: READ FILE                                                â”‚   â”‚
â”‚  â”‚ â€¢ SAS: Try encodings (UTF-8, Latin-1, Windows-1252)             â”‚   â”‚
â”‚  â”‚ â€¢ Parquet: Direct read                                           â”‚   â”‚
â”‚  â”‚ â€¢ CSV: Detect delimiter, infer types                             â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 40%                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 3: DATE STANDARDIZATION (SAS only)                          â”‚   â”‚
â”‚  â”‚ â€¢ Parse date columns (DTC, DT suffixes)                          â”‚   â”‚
â”‚  â”‚ â€¢ Handle partial dates (imputation rules)                        â”‚   â”‚
â”‚  â”‚ â€¢ Convert to ISO 8601                                            â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 60%                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 4: SCHEMA VALIDATION                                        â”‚   â”‚
â”‚  â”‚ â€¢ Compare with previous version (if exists)                      â”‚   â”‚
â”‚  â”‚ â€¢ Detect added/removed/changed columns                           â”‚   â”‚
â”‚  â”‚ â€¢ Check for breaking changes                                     â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 75%                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 5: LOAD TO DUCKDB                                           â”‚   â”‚
â”‚  â”‚ â€¢ Create/replace table                                           â”‚   â”‚
â”‚  â”‚ â€¢ Update _sage_metadata                                          â”‚   â”‚
â”‚  â”‚ â€¢ Create version record                                          â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90%                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 6: VALIDATION & QUALITY SCORE                               â”‚   â”‚
â”‚  â”‚ â€¢ Verify row counts                                              â”‚   â”‚
â”‚  â”‚ â€¢ Check column types                                             â”‚   â”‚
â”‚  â”‚ â€¢ Calculate null percentages                                     â”‚   â”‚
â”‚  â”‚ â€¢ Generate quality score (0-100)                                 â”‚   â”‚
â”‚  â”‚ Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                               â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ RESULT                                                           â”‚   â”‚
â”‚  â”‚ âœ“ Table: DM                                                      â”‚   â”‚
â”‚  â”‚ âœ“ Rows: 520                                                      â”‚   â”‚
â”‚  â”‚ âœ“ Columns: 25                                                    â”‚   â”‚
â”‚  â”‚ âœ“ Quality Score: 95/100                                          â”‚   â”‚
â”‚  â”‚ âœ“ Version: v2                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Current Implementation Status

| Component | File | Status |
|-----------|------|--------|
| SAS Reader | `core/data/sas_reader.py` | âœ… Complete |
| Date Handler | `core/data/date_handler.py` | âœ… Complete |
| DuckDB Loader | `core/data/duckdb_loader.py` | âœ… Complete |
| Data Validator | `scripts/validators/data_validator.py` | âœ… Complete |
| CLI Pipeline | `scripts/factory1_data.py` | âœ… Complete |
| API Router | `docker/api/routers/data.py` | ðŸ”„ Needs Enhancement |
| Frontend UI | `DataManagementPage.tsx` | ðŸ”„ Needs Enhancement |

### Files to Create/Modify

| File | Purpose | Status |
|------|---------|--------|
| `core/data/universal_reader.py` | Unified reader for all formats | â¬œ New |
| `core/data/csv_reader.py` | CSV with delimiter detection | â¬œ New |
| `core/data/schema_tracker.py` | Schema versioning & diff | â¬œ New |
| `docker/api/routers/data.py` | Real processing with SSE | ðŸ”„ Enhance |
| `DataFoundryPage.tsx` | Complete UI rewrite | ðŸ”„ Enhance |

---

## Factory 2: Metadata Refinery

### Overview

Factory 2 transforms Excel specification files into approved, structured metadata that the LLM uses to understand the data. This is **COMPLETE**.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FACTORY 2: METADATA REFINERY                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚  Excel Specs    â”‚   SDTM Spec (.xlsx)   ADaM Spec (.xlsx)           â”‚
â”‚  â”‚  (User Upload)  â”‚                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚  ExcelParser    â”‚   â€¢ Auto-detect domain/codelist sheets            â”‚
â”‚  â”‚  (520 lines)    â”‚   â€¢ Parse 30+ column mappings                     â”‚
â”‚  â”‚                 â”‚   â€¢ Handle SDTM + ADaM formats                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚ CodelistMerger  â”‚   â€¢ Link codelists to variables                   â”‚
â”‚  â”‚  (335 lines)    â”‚   â€¢ Populate allowed values                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚  LLMDrafter     â”‚   â€¢ Generate plain-English descriptions           â”‚
â”‚  â”‚  (539 lines)    â”‚   â€¢ DeepSeek-R1:8b backend                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                    MetadataStore (787 lines)                   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚                  golden_metadata.json                    â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 53 domains (AK112 study)                              â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 3478 variables (SDTM: 2625, ADaM: 853)               â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 69 codelists                                          â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Status: pending/approved/rejected per variable        â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â”‚                             â”‚                                  â”‚     â”‚
â”‚  â”‚                             â–¼                                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚            metadata_versions.db (SQLite)                 â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Version history (v1, v2, v3...)                       â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Change tracking (added/modified/deleted)              â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Approval audit trail                                  â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Rollback capability                                   â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Factory 2.5: CDISC Standards Library

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FACTORY 2.5: CDISC STANDARDS LIBRARY                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                    cdisc_library.db (SQLite)                   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚  SDTM IG v3.4                                            â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 63 domains                                            â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 1917 variables                                        â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ Core designation (Req/Exp/Perm)                       â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚  ADaM IG v1.3                                            â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 3 domains                                             â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ 435 variables                                         â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â”‚  TOTAL: 66 domains, 2352 standard variables                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  AUTO-APPROVAL ENGINE:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  5-Tier Confidence Matching:                                   â”‚     â”‚
â”‚  â”‚  1. Exact domain+name (95-100%) â†’ AUTO-APPROVE                â”‚     â”‚
â”‚  â”‚  2. Name any domain (85-88%) â†’ AUTO-APPROVE                   â”‚     â”‚
â”‚  â”‚  3. Standard suffixes (75%) â†’ AUTO-APPROVE                    â”‚     â”‚
â”‚  â”‚  4. Universal IDs (98%) â†’ AUTO-APPROVE                        â”‚     â”‚
â”‚  â”‚  5. Label similarity (70-84%) â†’ QUICK REVIEW                  â”‚     â”‚
â”‚  â”‚                                                                â”‚     â”‚
â”‚  â”‚  Thresholds:                                                   â”‚     â”‚
â”‚  â”‚  â€¢ >= 85%: AUTO-APPROVE (instant)                             â”‚     â”‚
â”‚  â”‚  â€¢ 60-84%: QUICK REVIEW (human glance)                        â”‚     â”‚
â”‚  â”‚  â€¢ < 60%: MANUAL REVIEW (detailed review)                     â”‚     â”‚
â”‚  â”‚                                                                â”‚     â”‚
â”‚  â”‚  Results: ~55% auto-approved, ~10% quick review, ~35% manual  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Admin UI Features (Complete)

**Metadata Auditor** (`/metadata`):
- 7 Tabs: Domains, Variables, Codelists, Issues, Upload, Compare, History
- Status badges (Pending/Approved/Rejected)
- Approve/Reject buttons per variable
- "Approve All" bulk action per domain (single version entry)
- Variable detail slide-out panel
- Auto-Approve with CDISC matching
- Version history with restore capability
- Export (approved only or all)

**CDISC Library Browser** (`/cdisc-library`):
- Overview tab: Stats cards, descriptions
- SDTM IG tab: 63 domains with drill-down
- ADaM IG tab: 3 datasets with drill-down
- Search tab: Cross-standard lookup

### Implementation Status: âœ… COMPLETE

| Component | File | Lines | Status |
|-----------|------|-------|--------|
| Excel Parser | `core/metadata/excel_parser.py` | 520 | âœ… |
| Codelist Merger | `core/metadata/codelist_merger.py` | 335 | âœ… |
| LLM Drafter | `core/metadata/llm_drafter.py` | 539 | âœ… |
| Version Control | `core/metadata/version_control.py` | 781 | âœ… |
| Metadata Store | `core/metadata/metadata_store.py` | 787 | âœ… |
| CDISC Library | `core/metadata/cdisc_library.py` | ~500 | âœ… |
| Auto Approval | `core/metadata/auto_approval.py` | ~300 | âœ… |
| API Router | `docker/api/routers/metadata.py` | ~600 | âœ… |
| UI Page | `MetadataAuditorPage.tsx` | ~2000 | âœ… |

---

## Factory 3: Dictionary Plant

### Overview

Factory 3 builds fuzzy matching indexes by scanning actual data values from DuckDB (Factory 1 output) and combining with metadata definitions (Factory 2). This enables typo correction and term resolution for query understanding in Factory 4.

**Status:** âœ… Complete (December 2024)

**Design Decision:** Semantic/embedding search has been intentionally excluded. Clinical data requires exact terminology matching using controlled vocabularies (MedDRA). Synonym matching is handled via the MedDRA hierarchy (Factory 3.5), not AI embeddings.

**Critical Dependency:** Factory 4 (Inference Engine) uses Factory 3's fuzzy matching for entity extraction and typo correction.

### Inputs & Outputs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FACTORY 3: DICTIONARY PLANT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  INPUTS:                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ clinical_data.duckdbâ”‚      â”‚ golden_metadata.jsonâ”‚           â”‚   â”‚
â”‚  â”‚  â”‚ (Factory 1 output)  â”‚      â”‚ (Factory 2 output)  â”‚           â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚      â”‚                     â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Actual data values: â”‚      â”‚ Variable meanings:  â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ AEDECOD: Headache â”‚      â”‚ â€¢ AEDECOD: "Dict-   â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ CMTRT: TYLENOL    â”‚      â”‚   derived AE term"  â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ LBTEST: Glucose   â”‚      â”‚ â€¢ Plain English     â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      DICTIONARY BUILDER                          â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  1. VALUE SCANNER                                                â”‚   â”‚
â”‚  â”‚     â€¢ Scan unique values from controlled columns                â”‚   â”‚
â”‚  â”‚     â€¢ Filter: AEDECOD, AEBODSYS (not AETERM - free text)       â”‚   â”‚
â”‚  â”‚     â€¢ Exclude: Y/N flags, short codes, ID columns              â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  2. FUZZY INDEX BUILDER (RapidFuzz)                             â”‚   â”‚
â”‚  â”‚     â€¢ Smart scoring: ratio (40%) + token_sort (30%) +           â”‚   â”‚
â”‚  â”‚       token_set (20%) + partial (10%)                           â”‚   â”‚
â”‚  â”‚     â€¢ Length ratio filtering (prevents false positives)         â”‚   â”‚
â”‚  â”‚     â€¢ Multi-strategy matching                                   â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  3. SCHEMA MAPPER                                                â”‚   â”‚
â”‚  â”‚     â€¢ Column â†’ table lookups                                    â”‚   â”‚
â”‚  â”‚     â€¢ Sample values and statistics                              â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                    â”‚
â”‚                                    â–¼                                    â”‚
â”‚  OUTPUTS:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚   â”‚
â”‚  â”‚  â”‚ fuzzy_index.pkl     â”‚  RapidFuzz index (~15K entries)        â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚  "headche" â†’ "Headache" (79.6%)        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚   â”‚
â”‚  â”‚  â”‚ schema_map.json     â”‚  Column lookup table                   â”‚   â”‚
â”‚  â”‚  â”‚                     â”‚  11 tables, column metadata            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚   â”‚
â”‚  â”‚  â”‚ dictionary_status   â”‚  Build timestamp and statistics        â”‚   â”‚
â”‚  â”‚  â”‚ .json               â”‚  Progress tracking for UI              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Columns to Scan

**Note:** Free-text columns (AETERM, MHTERM) and flag columns (Y/N values) are excluded to prevent false matches.

| Domain | Columns | Purpose | Status |
|--------|---------|---------|--------|
| **AE** | AEDECOD, AEBODSYS, AESOC, AEHLT, AELLT | Controlled AE terms | âœ… |
| **CM** | CMTRT, CMDECOD, CMCLAS, CMCAT, CMINDC | Drug names, classes | âœ… |
| **LB** | LBTEST, LBTESTCD, LBCAT, LBSCAT, LBSPEC | Lab test names | âœ… |
| **VS** | VSTEST, VSTESTCD, VSPOS, VSLOC | Vital signs | âœ… |
| **DM** | SEX, RACE, ETHNIC, COUNTRY, ARM, ARMCD, ACTARM | Demographics | âœ… |
| **MH** | MHDECOD, MHBODSYS, MHCAT | Medical history (controlled) | âœ… |
| **ADSL** | SEX, RACE, ETHNIC, TRT01P, TRT01A, ARM, ACTARM, AGEGR1 | Analysis subjects | âœ… |
| **ADAE** | AEDECOD, AEBODSYS, AESOC, AEHLT, AELLT, AEACN, AEOUT, AETOXGR | ADaM AE analysis | âœ… |
| **ADLB** | PARAM, PARAMCD, PARCAT1, AVISIT, ANRIND, BNRIND | ADaM Lab analysis | âœ… |

**Excluded Columns:**
- `AETERM`, `MHTERM` - Free text verbatim terms (not controlled vocabulary)
- `*SER`, `*REL`, `*FL` - Flag columns (Y/N values cause false matches)
- `*_CODE` - Numeric MedDRA codes (not searchable text)
- `USUBJID`, `STUDYID`, `SUBJID` - ID columns

### Fuzzy Matching Examples (Tested & Verified)

| User Input | Matched Value | Table.Column | Score | Use Case |
|------------|---------------|--------------|-------|----------|
| "headche" | Headache | AE.AEDECOD | 79.6% | Typo correction |
| "hypertention" | Hypertension | ADAE.AEDECOD | 83.7% | Spelling error |
| "nausea" | Nausea | AE.AEDECOD | 100% | Exact match |
| "diabetis" | Diabetes mellitus | MEDDRA_HIERARCHY | 70%+ | Medical term typo |
| "Myocardial infarction" | Myocardial infarction | AE.AEDECOD | 100% | Exact match |

**Smart Scoring Algorithm:**
- Prevents false positives (e.g., "Y" no longer matches "TYLENOL")
- Length ratio filtering: value must be 40-300% of query length
- Weighted scoring: ratio (40%) + token_sort (30%) + token_set (20%) + partial (10%)
- Length similarity bonus for better matches

**MedDRA Integration (Factory 3.5):**
- Synonym matching via MedDRA hierarchy (PT â†’ HLT â†’ HLGT â†’ SOC)
- "fever" â†’ finds "Pyrexia" via MedDRA lookup, not fuzzy matching

### Module Architecture

```
core/dictionary/                    # âœ… All Complete
â”œâ”€â”€ __init__.py                     # Module exports
â”œâ”€â”€ value_scanner.py                # Extract unique values from DuckDB
â”œâ”€â”€ fuzzy_matcher.py                # RapidFuzz smart matching (no false positives)
â”œâ”€â”€ schema_mapper.py                # Generate schema_map.json
â””â”€â”€ term_resolver.py                # Combined fuzzy + MedDRA lookup

core/meddra/                        # âœ… Factory 3.5 - MedDRA Library
â”œâ”€â”€ __init__.py                     # Module exports
â”œâ”€â”€ loader.py                       # Load MedDRA ASCII files
â”œâ”€â”€ library.py                      # Query MedDRA hierarchy
â””â”€â”€ models.py                       # MedDRA data models
```

**Removed Modules (Design Decision):**
- `embedding_generator.py` - Not needed; clinical data uses controlled vocabularies
- `chroma_store.py` - Not needed; MedDRA hierarchy handles synonyms
- `hybrid_matcher.py` - Replaced by `term_resolver.py` (fuzzy + MedDRA)

### Component Details

#### 3.1 Value Scanner (`value_scanner.py`)

**Purpose:** Scan DuckDB tables and extract unique values from key columns.

```python
class ValueScanner:
    """Scans clinical data tables for unique values."""

    def __init__(self, db_path: str, metadata_path: str):
        """
        Args:
            db_path: Path to clinical_data.duckdb
            metadata_path: Path to golden_metadata.json
        """

    def scan_table(self, table_name: str) -> Dict[str, List[str]]:
        """Extract unique values from scannable columns."""

    def scan_all_tables(self) -> Dict[str, Dict[str, List[str]]]:
        """Scan all tables, return nested dict of values."""

    def get_scannable_columns(self, table_name: str) -> List[str]:
        """Identify columns worth scanning (VARCHAR, low cardinality)."""

    def get_statistics(self) -> Dict[str, Any]:
        """Return scan statistics (counts, tables, columns)."""
```

**Output format:**
```json
{
  "AE": {
    "AETERM": ["HEADACHE", "NAUSEA", "FATIGUE", "DIZZINESS", ...],
    "AEDECOD": ["Headache", "Nausea", "Fatigue", ...],
    "AEBODSYS": ["Nervous system disorders", "Gastrointestinal disorders", ...]
  },
  "CM": {
    "CMTRT": ["TYLENOL", "ASPIRIN", "IBUPROFEN", ...],
    "CMDECOD": ["ACETAMINOPHEN", "ACETYLSALICYLIC ACID", ...]
  },
  "LB": {
    "LBTEST": ["Glucose", "Hemoglobin", "Creatinine", ...],
    "LBCAT": ["CHEMISTRY", "HEMATOLOGY", "URINALYSIS", ...]
  }
}
```

#### 3.2 Embedding Generator (`embedding_generator.py`)

**Purpose:** Create vector embeddings using Ollama's nomic-embed-text model.

```python
class EmbeddingGenerator:
    """Generates embeddings using Ollama."""

    def __init__(self, ollama_host: str = "http://ollama:11434"):
        """Initialize with Ollama connection."""

    def embed_text(self, text: str) -> List[float]:
        """Generate embedding for single text (768 dimensions)."""

    def embed_batch(self, texts: List[str], batch_size: int = 100) -> List[List[float]]:
        """Generate embeddings for batch of texts."""

    def embed_value_with_context(self,
                                  value: str,
                                  table: str,
                                  column: str,
                                  description: str) -> Dict:
        """Embed value with contextual metadata."""
```

**Embedding document format:**
```json
{
  "id": "AE.AETERM.HEADACHE",
  "text": "HEADACHE - Reported Term for the Adverse Event in AE table",
  "embedding": [0.123, -0.456, 0.789, ...],
  "metadata": {
    "table": "AE",
    "column": "AETERM",
    "value": "HEADACHE",
    "description": "Reported Term for the Adverse Event",
    "domain": "SDTM"
  }
}
```

#### 3.3 ChromaDB Store (`chroma_store.py`)

**Purpose:** Manage ChromaDB collections for semantic search.

**Collections:**
| Collection | Contents | Purpose |
|------------|----------|---------|
| `clinical_values` | All unique data values | Primary search |
| `variable_definitions` | Metadata descriptions | Concept mapping |
| `synonyms` | Custom synonym pairs | User-defined mappings |

```python
class ChromaStore:
    """Manages ChromaDB collections for semantic search."""

    def __init__(self, persist_dir: str = "knowledge/chroma"):
        """Initialize persistent ChromaDB client."""

    def get_or_create_collection(self, name: str) -> Collection:
        """Get or create a named collection."""

    def add_documents(self, collection: str, documents: List[Dict]) -> int:
        """Add documents with embeddings to collection."""

    def search(self, collection: str, query: str,
               n_results: int = 10,
               filter_metadata: Dict = None) -> List[SearchResult]:
        """Semantic search with optional filtering."""

    def get_collection_stats(self, collection: str) -> Dict:
        """Get document count and metadata stats."""

    def rebuild_collection(self, collection: str) -> None:
        """Delete and recreate collection."""
```

#### 3.4 Fuzzy Matcher (`fuzzy_matcher.py`)

**Purpose:** Fast string matching using RapidFuzz library.

**Matching strategies:**
1. **Simple ratio** - Basic Levenshtein similarity
2. **Partial ratio** - Best substring match
3. **Token sort ratio** - Word order insensitive
4. **Token set ratio** - Handles extra/missing words

```python
from rapidfuzz import fuzz, process

@dataclass
class FuzzyMatch:
    value: str           # Matched value
    score: float         # Match score (0-100)
    table: str           # Source table
    column: str          # Source column
    match_type: str      # "exact", "fuzzy", "partial"

class FuzzyMatcher:
    """RapidFuzz-based string matcher."""

    def __init__(self):
        """Initialize empty matcher."""

    def build_index(self, values: Dict[str, Dict[str, List[str]]]) -> None:
        """Build flat index from nested value dict."""

    def match(self, query: str,
              threshold: float = 80.0,
              limit: int = 10) -> List[FuzzyMatch]:
        """Find fuzzy matches across all values."""

    def match_in_column(self, query: str,
                        table: str, column: str,
                        threshold: float = 80.0) -> List[FuzzyMatch]:
        """Match within specific table.column."""

    def save(self, path: str) -> None:
        """Save index to pickle file."""

    @classmethod
    def load(cls, path: str) -> 'FuzzyMatcher':
        """Load index from pickle file."""
```

#### 3.5 Hybrid Matcher (`hybrid_matcher.py`)

**Purpose:** Combine fuzzy and semantic matching for optimal results.

```python
@dataclass
class HybridMatch:
    value: str
    combined_score: float    # Weighted combination
    fuzzy_score: float       # From FuzzyMatcher
    semantic_score: float    # From ChromaDB
    table: str
    column: str
    sql_hint: str           # e.g., "AETERM = 'HEADACHE'"

class HybridMatcher:
    """Combines fuzzy and semantic matching."""

    def __init__(self,
                 fuzzy_matcher: FuzzyMatcher,
                 chroma_store: ChromaStore,
                 embedding_generator: EmbeddingGenerator):
        """Initialize with component matchers."""

    def match(self, query: str,
              fuzzy_weight: float = 0.6,
              semantic_weight: float = 0.4,
              threshold: float = 0.7,
              limit: int = 10) -> List[HybridMatch]:
        """
        Combined matching pipeline:
        1. Get fuzzy matches (fast, good for typos)
        2. Get semantic matches (slower, good for synonyms)
        3. Merge results by value
        4. Calculate weighted combined score
        5. Rank and filter by threshold
        """

    def extract_entities(self, text: str) -> List[Entity]:
        """
        Extract clinical entities from natural language.

        Example:
        Input: "patients with headaches taking tylenol"
        Output: [
            Entity(value='HEADACHE', table='AE', column='AETERM'),
            Entity(value='TYLENOL', table='CM', column='CMTRT')
        ]
        """
```

#### 3.6 Schema Mapper (`schema_mapper.py`)

**Purpose:** Generate quick lookup JSON for column/table relationships.

```python
class SchemaMapper:
    """Generates schema_map.json for fast lookups."""

    def __init__(self, db_path: str, metadata_path: str):
        """Initialize with data sources."""

    def generate(self) -> Dict:
        """Generate complete schema map."""

    def save(self, path: str) -> None:
        """Save schema map to JSON file."""
```

**Output format (`schema_map.json`):**
```json
{
  "generated_at": "2024-12-12T10:30:00Z",
  "columns": {
    "USUBJID": {
      "tables": ["DM", "AE", "LB", "VS", "CM", "ADSL", "ADAE"],
      "type": "VARCHAR",
      "is_key": true,
      "description": "Unique Subject Identifier"
    },
    "AETERM": {
      "tables": ["AE"],
      "type": "VARCHAR",
      "is_key": false,
      "description": "Reported Term for the Adverse Event",
      "unique_values_count": 847,
      "sample_values": ["HEADACHE", "NAUSEA", "FATIGUE"]
    },
    "LBTEST": {
      "tables": ["LB"],
      "type": "VARCHAR",
      "is_key": false,
      "description": "Lab Test Name",
      "unique_values_count": 156,
      "sample_values": ["Glucose", "Hemoglobin", "Creatinine"]
    }
  },
  "tables": {
    "AE": {
      "domain": "SDTM",
      "description": "Adverse Events",
      "row_count": 15234,
      "columns": ["STUDYID", "USUBJID", "AETERM", "AEDECOD", "AESTDTC", ...],
      "key_columns": ["USUBJID", "AESEQ"]
    },
    "DM": {
      "domain": "SDTM",
      "description": "Demographics",
      "row_count": 500,
      "columns": ["STUDYID", "USUBJID", "AGE", "SEX", "RACE", ...],
      "key_columns": ["USUBJID"]
    }
  },
  "statistics": {
    "total_tables": 12,
    "total_columns": 287,
    "total_unique_values": 24583,
    "scannable_columns": 45
  }
}
```

### CLI Pipeline (`scripts/factory3_dictionary.py`)

```python
"""
Factory 3: Dictionary Plant - Build CLI

Usage:
    python scripts/factory3_dictionary.py              # Full build
    python scripts/factory3_dictionary.py --rebuild    # Force rebuild all
    python scripts/factory3_dictionary.py --table AE   # Single table only
    python scripts/factory3_dictionary.py --stats      # Show statistics only
"""

def main():
    """
    Factory 3 Dictionary Build Pipeline

    Steps:
    1. Verify prerequisites (Factory 1 + Factory 2 outputs exist)
    2. Scan unique values from DuckDB tables
    3. Generate embeddings via Ollama (nomic-embed-text)
    4. Store embeddings in ChromaDB collections
    5. Build fuzzy matching index
    6. Generate schema_map.json
    7. Save all artifacts to knowledge/
    8. Run validation tests
    9. Print summary statistics
    """
```

### API Router (`docker/api/routers/dictionary.py`)

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/dictionary/status` | Build status, statistics | User |
| POST | `/dictionary/build` | Trigger full rebuild | Admin |
| POST | `/dictionary/build/{table}` | Rebuild single table | Admin |
| POST | `/dictionary/search` | Search for matches | User |
| GET | `/dictionary/values/{table}` | List unique values | User |
| GET | `/dictionary/values/{table}/{column}` | Values for column | User |
| GET | `/dictionary/schema-map` | Get schema map | User |
| POST | `/dictionary/synonyms` | Add custom synonym | Admin |
| GET | `/dictionary/synonyms` | List synonyms | User |
| DELETE | `/dictionary/synonyms/{id}` | Delete synonym | Admin |

**Search request/response:**
```json
// POST /dictionary/search
{
  "query": "Tyleonl",
  "threshold": 0.8,
  "limit": 5,
  "table_filter": null,
  "column_filter": null
}

// Response
{
  "success": true,
  "data": {
    "query": "Tyleonl",
    "matches": [
      {
        "value": "TYLENOL",
        "combined_score": 0.95,
        "fuzzy_score": 0.97,
        "semantic_score": 0.92,
        "table": "CM",
        "column": "CMTRT",
        "sql_hint": "CMTRT = 'TYLENOL'"
      }
    ],
    "search_time_ms": 45
  }
}
```

### Admin UI (`DictionaryManagerPage.tsx`)

**Tabs:**
| Tab | Purpose |
|-----|---------|
| **Status** | Build status, last updated, statistics dashboard |
| **Search** | Interactive search testing with results preview |
| **Values** | Browse unique values by table/column |
| **Synonyms** | Manage custom synonym mappings |
| **Rebuild** | Trigger rebuild with options, view progress |

### Implementation Status: â¬œ NOT STARTED

| Component | File | Lines (est.) | Status |
|-----------|------|--------------|--------|
| Module init | `core/dictionary/__init__.py` | 50 | â¬œ |
| Value Scanner | `core/dictionary/value_scanner.py` | 200 | â¬œ |
| Embedding Generator | `core/dictionary/embedding_generator.py` | 150 | â¬œ |
| ChromaDB Store | `core/dictionary/chroma_store.py` | 200 | â¬œ |
| Fuzzy Matcher | `core/dictionary/fuzzy_matcher.py` | 250 | â¬œ |
| Hybrid Matcher | `core/dictionary/hybrid_matcher.py` | 200 | â¬œ |
| Schema Mapper | `core/dictionary/schema_mapper.py` | 150 | â¬œ |
| CLI Pipeline | `scripts/factory3_dictionary.py` | 300 | â¬œ |
| API Router | `docker/api/routers/dictionary.py` | 400 | â¬œ |
| UI Page | `DictionaryManagerPage.tsx` | 500 | â¬œ |
| **Total** | | **~2,400** | |

### Dependencies

**Python packages (add to requirements.txt):**
```
rapidfuzz>=3.0.0          # Fast fuzzy string matching
```

**Already available:**
- `chromadb` - Vector database (container running)
- `duckdb` - Data access (Factory 1)
- Ollama with `nomic-embed-text` - Embeddings (container running)

### Testing Strategy

#### Unit Tests (`tests/factory3/`)

| Test File | Coverage |
|-----------|----------|
| `test_value_scanner.py` | ValueScanner methods |
| `test_embedding_generator.py` | Ollama integration |
| `test_chroma_store.py` | ChromaDB operations |
| `test_fuzzy_matcher.py` | Fuzzy matching accuracy |
| `test_hybrid_matcher.py` | Combined matching |
| `test_schema_mapper.py` | Schema map generation |

#### Integration Tests

```python
# tests/factory3/test_integration.py

def test_full_pipeline():
    """Test complete dictionary build pipeline."""

def test_search_typo_correction():
    """Test: 'Tyleonl' â†’ 'TYLENOL' with >90% score."""

def test_search_semantic():
    """Test: 'fever' finds 'PYREXIA' via semantic search."""

def test_entity_extraction():
    """Test: Extract entities from natural language."""
```

#### Accuracy Tests

| Test Case | Input | Expected Match | Min Score |
|-----------|-------|----------------|-----------|
| Typo 1 | "Tyleonl" | TYLENOL | 90% |
| Typo 2 | "acetominophen" | ACETAMINOPHEN | 90% |
| Typo 3 | "head ache" | HEADACHE | 85% |
| Synonym 1 | "fever" | PYREXIA | 80% |
| Synonym 2 | "high blood pressure" | HYPERTENSION | 80% |
| Concept 1 | "safety population" | SAFFL='Y' | 75% |
| Concept 2 | "glucose levels" | LBTEST='GLUCOSE' | 85% |

#### Performance Tests

| Metric | Target |
|--------|--------|
| Full index build | < 5 minutes |
| Single query (fuzzy) | < 50ms |
| Single query (semantic) | < 200ms |
| Single query (hybrid) | < 250ms |
| Batch search (100 queries) | < 5 seconds |

### Success Criteria

1. **Fuzzy Matching:**
   - [ ] Common typos corrected with >90% accuracy
   - [ ] Space/case variations handled
   - [ ] Index build < 5 minutes

2. **Semantic Search:**
   - [ ] Medical synonyms found (feverâ†’pyrexia)
   - [ ] Concept mapping works (safety populationâ†’SAFFL)
   - [ ] ChromaDB collections populated

3. **Integration:**
   - [ ] API endpoints functional
   - [ ] UI displays search results
   - [ ] Factory 4 can use HybridMatcher

4. **Artifacts Generated:**
   - [ ] `knowledge/chroma/` populated
   - [ ] `knowledge/fuzzy_index.pkl` created
   - [ ] `knowledge/schema_map.json` created

---

## Factory 4: Inference Engine

### Overview

Factory 4 is the runtime query processing engine - the **final piece** that brings everything together. It takes natural language questions from users, uses the indexes from Factory 3 to understand intent, retrieves context from Factory 2 metadata, generates SQL using the LLM, executes against Factory 1 data, and returns results with confidence scores and explanations.

**Status:** â¬œ Not Started (Dependencies Complete)

**Core Principle:** The AI acts as a **TRANSLATOR**, not an EXPERT. Mathematical calculations are performed by generated code (SQL), not by probabilistic AI inference. This ensures reproducible, auditable, and deterministic results.

### How All Factories Connect

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        THE SAGE FACTORY PIPELINE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   FACTORY 1     â”‚      â”‚   FACTORY 2     â”‚      â”‚   FACTORY 3     â”‚          â”‚
â”‚  â”‚  Data Foundry   â”‚      â”‚ Metadata Refineryâ”‚     â”‚ Dictionary Plantâ”‚          â”‚
â”‚  â”‚      âœ…         â”‚      â”‚      âœ…          â”‚      â”‚      âœ…         â”‚          â”‚
â”‚  â”‚                 â”‚      â”‚                 â”‚      â”‚                 â”‚          â”‚
â”‚  â”‚  Output:        â”‚      â”‚  Output:        â”‚      â”‚  Output:        â”‚          â”‚
â”‚  â”‚  clinical_      â”‚      â”‚  golden_        â”‚      â”‚  fuzzy_index    â”‚          â”‚
â”‚  â”‚  data.duckdb    â”‚      â”‚  metadata.json  â”‚      â”‚  schema_map     â”‚          â”‚
â”‚  â”‚                 â”‚      â”‚  cdisc_lib.db   â”‚      â”‚  meddra.db      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                        â”‚                        â”‚                    â”‚
â”‚           â”‚         BUILD TIME     â”‚                        â”‚                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚           â”‚                        â”‚                        â”‚                    â”‚
â”‚           â–¼                        â–¼                        â–¼        RUNTIME     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          FACTORY 4: INFERENCE ENGINE                      â”‚   â”‚
â”‚  â”‚                                    â¬œ                                     â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â”‚   User Query â”€â”€â–º Sanitize â”€â”€â–º Fuzzy Match â”€â”€â–º Route â”€â”€â–º Generate SQL     â”‚   â”‚
â”‚  â”‚                                                              â”‚            â”‚   â”‚
â”‚  â”‚                                                              â–¼            â”‚   â”‚
â”‚  â”‚   Response â—„â”€â”€ Explain â—„â”€â”€ Score â—„â”€â”€ Execute â—„â”€â”€ Validate â—„â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What Each Factory Provides to Factory 4

| Factory | Output | Used By Factory 4 For |
|---------|--------|----------------------|
| **F1 - Data** | `clinical_data.duckdb` | SQL execution target (11 tables) |
| **F2 - Metadata** | `golden_metadata.json` | Variable descriptions, LLM context |
| **F2.5 - CDISC** | `cdisc_library.db` | Standard variable definitions |
| **F3 - Dictionary** | `fuzzy_index.pkl` | Typo correction, entity resolution |
| **F3.5 - MedDRA** | `meddra_library.db` | Medical term synonyms, hierarchy |

### Clinical Rules Engine: The 200% Accuracy Approach

Factory 4 uses a **dual-layer architecture**: Clinical Rules Engine + LLM. This ensures clinical data accuracy through deterministic rules while leveraging LLM for natural language understanding.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAGE CLINICAL QUERY PRINCIPLES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. ADaM FIRST: Always prefer ADaM over SDTM when both exist               â”‚
â”‚     ADAE > AE, ADSL > DM, ADLB > LB, ADVS > VS                             â”‚
â”‚                                                                             â”‚
â”‚  2. SAFETY DEFAULT: Any safety query uses SAFFL='Y' unless specified       â”‚
â”‚                                                                             â”‚
â”‚  3. ANALYSIS COLUMNS: Use derived analysis columns over raw                â”‚
â”‚     ATOXGR > AETOXGR, AVAL > raw values                                    â”‚
â”‚                                                                             â”‚
â”‚  4. TRANSPARENCY: Every answer includes:                                   â”‚
â”‚     - Source table(s) used                                                 â”‚
â”‚     - Population filter applied                                            â”‚
â”‚     - Column definitions used                                              â”‚
â”‚                                                                             â”‚
â”‚  5. NEVER ASSUME: When ambiguous, ASK the user                             â”‚
â”‚                                                                             â”‚
â”‚  6. AUDIT TRAIL: Every query logged with full methodology                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### LLM + Clinical Guardrails Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SAGE INFERENCE ENGINE ARCHITECTURE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  User Query: "Show me patients on Drug X who got hypertension after week 4"â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CLINICAL RULES ENGINE (Pre-LLM)                                    â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚   â”‚
â”‚  â”‚  â€¢ Detects: This is an AE query â†’ Use ADAE (not AE)                â”‚   â”‚
â”‚  â”‚  â€¢ Detects: Safety-related â†’ Add SAFFL='Y' context                 â”‚   â”‚
â”‚  â”‚  â€¢ Detects: "hypertension" â†’ Fuzzy match to AEDECOD='HYPERTENSION' â”‚   â”‚
â”‚  â”‚  â€¢ Provides: Available columns (ATOXGR exists, use it)             â”‚   â”‚
â”‚  â”‚  â€¢ Provides: Schema context for LLM                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DeepSeek-R1 LLM (The Brain)                                        â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚   â”‚
â”‚  â”‚  Receives:                                                          â”‚   â”‚
â”‚  â”‚    â€¢ User's natural language query                                  â”‚   â”‚
â”‚  â”‚    â€¢ Schema context (ADAE table, relevant columns)                  â”‚   â”‚
â”‚  â”‚    â€¢ Clinical rules (use SAFFL='Y', use ATOXGR)                    â”‚   â”‚
â”‚  â”‚    â€¢ Entity resolution (hypertension â†’ HYPERTENSION)               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Generates:                                                         â”‚   â”‚
â”‚  â”‚    â€¢ Complex SQL handling "after week 4" logic                     â”‚   â”‚
â”‚  â”‚    â€¢ Joins if needed (ADAE + ADSL for drug info)                   â”‚   â”‚
â”‚  â”‚    â€¢ Proper date/time calculations                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CLINICAL RULES ENGINE (Post-LLM)                                   â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚   â”‚
â”‚  â”‚  â€¢ Validates: SQL uses correct tables/columns                      â”‚   â”‚
â”‚  â”‚  â€¢ Validates: No dangerous operations                               â”‚   â”‚
â”‚  â”‚  â€¢ Ensures: SAFFL='Y' was applied                                  â”‚   â”‚
â”‚  â”‚  â€¢ Adds: Methodology explanation                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚                     Execute & Return                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Clinical Rules Engine Components

| Component | File | Purpose |
|-----------|------|---------|
| **ClinicalConfig** | `clinical_config.py` | Defines table priorities, column priorities, population rules |
| **TableResolver** | `table_resolver.py` | Selects correct table (ADaM > SDTM), applies population filters |
| **ColumnResolver** | `table_resolver.py` | Selects correct columns (ATOXGR > AETOXGR) |
| **ResponseBuilder** | `response_builder.py` | Adds mandatory methodology transparency |

#### Table Priority Rules

| Domain | ADaM Table | SDTM Table | Rule |
|--------|-----------|------------|------|
| Adverse Events | ADAE | AE | If ADAE exists, always use ADAE |
| Demographics | ADSL | DM | If ADSL exists, always use ADSL |
| Concomitant Meds | ADCM | CM | If ADCM exists, use ADCM |
| Labs | ADLB | LB | If ADLB exists, use ADLB |
| Vital Signs | ADVS | VS | If ADVS exists, use ADVS |

#### Column Priority Rules

| Concept | Preferred | Fallback | Reason |
|---------|-----------|----------|--------|
| Toxicity Grade | ATOXGR | AETOXGR | ATOXGR is maximum grade reached |
| Severity | ASEV | AESEV | ASEV is analysis severity |
| Treatment | TRT01A | TRT01P | TRT01A is actual treatment received |
| Analysis Value | AVAL | STRESN | AVAL is analysis-ready value |

#### Population Default Rules

| Query Type | Default Population | Flag |
|------------|-------------------|------|
| Adverse Events | Safety | SAFFL = 'Y' |
| Efficacy | ITT | ITTFL = 'Y' |
| Demographics | Safety | SAFFL = 'Y' |
| Labs | Safety | SAFFL = 'Y' |

#### Mandatory Response Transparency

Every response MUST include:

```
### Methodology

**Data Source:** ADAE (ADaM)
  - ADaM table preferred; contains population flags

**Population:** Safety Population (N=1,234)
  - Filter: `SAFFL = 'Y'`

**Key Columns Used:**
  - ATOXGR: Maximum toxicity grade (used over AETOXGR)
  - AEDECOD: MedDRA Preferred Term

**Filters Applied:**
  - `SAFFL = 'Y'` (Safety Population)
  - `AEDECOD = 'HEADACHE'`

**SQL Query:**
```sql
SELECT COUNT(DISTINCT USUBJID) FROM ADAE
WHERE SAFFL = 'Y' AND AEDECOD = 'HEADACHE'
```
```

### The Complete 9-Step Query Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FACTORY 4: COMPLETE QUERY PROCESSING PIPELINE                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  USER QUERY: "How many patients had headaches?"                                 â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 1: INPUT SANITIZATION                                                 â”‚  â”‚
â”‚  â”‚ File: core/engine/input_sanitizer.py                                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Check for:                                                                â”‚  â”‚
â”‚  â”‚  âœ“ PHI/PII patterns (SSN: \d{3}-\d{2}-\d{4}, emails, phone numbers)       â”‚  â”‚
â”‚  â”‚  âœ“ SQL injection ('; DROP TABLE --, UNION SELECT, OR 1=1)                 â”‚  â”‚
â”‚  â”‚  âœ“ Prompt injection ("Ignore previous instructions and...")                â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Result: âœ… SAFE - "How many patients had headaches?"                      â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 2: ENTITY EXTRACTION + FUZZY MATCHING                                 â”‚  â”‚
â”‚  â”‚ Uses: fuzzy_index.pkl (Factory 3) + meddra_library.db (Factory 3.5)        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Extract entities from query:                                              â”‚  â”‚
â”‚  â”‚  â€¢ "patients" â†’ subject count concept                                      â”‚  â”‚
â”‚  â”‚  â€¢ "headaches" â†’ clinical term to resolve                                  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Fuzzy Match "headaches":                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Match 1: "Headache" (AE.AEDECOD)     Score: 97.2%  Type: near_exact â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Match 2: "Headache" (ADAE.AEDECOD)   Score: 97.2%  Type: near_exact â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Match 3: "Headaches" (MEDDRA.HLGT)   Score: 100%   Type: exact      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  MedDRA Hierarchy Lookup:                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ PT: Headache (10019211)                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â–º HLT: Headaches (10019231)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€â–º HLGT: Headaches (10019233)                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚            â””â”€â–º SOC: Nervous system disorders (10029205)             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Output: FuzzyMatches with table.column locations + MedDRA context         â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 3: INTENT CLASSIFICATION (Query Router)                               â”‚  â”‚
â”‚  â”‚ File: core/engine/router.py                                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Analyze query to determine type:                                          â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â€¢ DATA Query â†’ "How many...", "Count...", "Show...", "List..."           â”‚  â”‚
â”‚  â”‚    â†’ Needs SQL generation and execution                                    â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â€¢ DOCUMENT Query â†’ "What is...", "Explain...", "Define..."               â”‚  â”‚
â”‚  â”‚    â†’ Needs RAG retrieval from documentation                                â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â€¢ HYBRID Query â†’ "Show AEs and explain the most common"                  â”‚  â”‚
â”‚  â”‚    â†’ Needs both SQL + explanation                                          â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Decision: ðŸ“Š DATA QUERY (needs SQL)                                       â”‚  â”‚
â”‚  â”‚  Confidence: 95%                                                           â”‚  â”‚
â”‚  â”‚  Reason: "How many" indicates count aggregation                            â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 4: METADATA RETRIEVAL                                                 â”‚  â”‚
â”‚  â”‚ Uses: golden_metadata.json (Factory 2)                                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Based on fuzzy matches (AE.AEDECOD), retrieve relevant metadata:          â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Domain: AE (Adverse Events)                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Description: "Adverse event records for each subject"               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Relevant Variables:                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ USUBJID   â”‚ Unique Subject Identifier â”‚ char â”‚ Primary Key    â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ AEDECOD   â”‚ Dictionary-Derived Term   â”‚ char â”‚ MedDRA PT      â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ AEBODSYS  â”‚ Body System (SOC)         â”‚ char â”‚ MedDRA SOC     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ AESER     â”‚ Serious Event Flag        â”‚ char â”‚ Y/N            â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”‚ AEREL     â”‚ Causality                 â”‚ char â”‚ Codelist       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Row Count: 1,247 adverse events                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Unique Subjects: 254                                                â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Context String assembled for LLM prompt                                   â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 5: SQL GENERATION (DeepSeek-R1 LLM)                                   â”‚  â”‚
â”‚  â”‚ File: core/engine/sql_generator.py                                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  PROMPT TO DEEPSEEK-R1:                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  SYSTEM:                                                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  You are SAGE, a clinical data SQL generator. Generate DuckDB SQL   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  queries for clinical trial data. Follow these rules:               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  1. Use ONLY the tables and columns provided below                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  2. Generate SELECT queries only (no INSERT/UPDATE/DELETE)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  3. Use proper DuckDB syntax                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  4. Use case-insensitive ILIKE for text matching                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  5. Always include relevant columns for context                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  AVAILABLE SCHEMA:                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Table: AE (Adverse Events)                                  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - USUBJID (VARCHAR): Unique Subject Identifier            â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - AEDECOD (VARCHAR): Dictionary-Derived Term [MedDRA PT]  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - AEBODSYS (VARCHAR): Body System (MedDRA SOC)            â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - AESER (VARCHAR): Serious Event Flag (Y/N)               â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - AESTDTC (VARCHAR): Start Date/Time                      â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                                                             â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Table: DM (Demographics)                                    â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - USUBJID (VARCHAR): Unique Subject Identifier            â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - AGE (INTEGER): Age                                      â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - SEX (VARCHAR): Sex (M/F)                                â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   - ARM (VARCHAR): Treatment Arm                            â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ENTITY RESOLUTION (from fuzzy matching):                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ "headaches" resolved to: AEDECOD = 'Headache' (97.2% confidence) â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ "patients" means: COUNT DISTINCT USUBJID                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  USER QUESTION:                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  "How many patients had headaches?"                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Generate the SQL query:                                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  DEEPSEEK-R1 RESPONSE:                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  <think>                                                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  The user wants to count unique patients with headaches.            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - "patients" = distinct USUBJID                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - "headaches" = AEDECOD containing 'Headache' (from entity res.)   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Use ILIKE for case-insensitive matching                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - AE table has the adverse event data                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  </think>                                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ```sql                                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  SELECT COUNT(DISTINCT USUBJID) AS patient_count                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  FROM AE                                                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  WHERE AEDECOD ILIKE '%Headache%'                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ```                                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Extracted SQL: SELECT COUNT(DISTINCT USUBJID) AS patient_count           â”‚  â”‚
â”‚  â”‚                 FROM AE WHERE AEDECOD ILIKE '%Headache%'                   â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 6: SQL VALIDATION                                                     â”‚  â”‚
â”‚  â”‚ File: core/engine/sql_validator.py                                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Validation Checks:                                                        â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  âœ… Syntax Check: Valid DuckDB SQL                                         â”‚  â”‚
â”‚  â”‚  âœ… Table Check: AE exists in database                                     â”‚  â”‚
â”‚  â”‚  âœ… Column Check: USUBJID, AEDECOD exist in AE table                       â”‚  â”‚
â”‚  â”‚  âœ… Operation Check: SELECT only (no DELETE/UPDATE/DROP/INSERT)            â”‚  â”‚
â”‚  â”‚  âœ… Injection Check: No suspicious patterns (UNION, --, etc.)              â”‚  â”‚
â”‚  â”‚  âœ… Permission Check: Read-only operation                                  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Result: âœ… VALID                                                          â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 7: SANDBOXED EXECUTION                                                â”‚  â”‚
â”‚  â”‚ File: core/engine/executor.py                                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Target: clinical_data.duckdb (Factory 1)                                  â”‚  â”‚
â”‚  â”‚  Connection: READ-ONLY mode                                                â”‚  â”‚
â”‚  â”‚  Timeout: 30 seconds (QUERY_TIMEOUT_SECONDS)                               â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Execution:                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ SELECT COUNT(DISTINCT USUBJID) AS patient_count                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ FROM AE                                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ WHERE AEDECOD ILIKE '%Headache%'                                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Result:                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚  â”‚
â”‚  â”‚  â”‚ patient_count   â”‚                                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                      â”‚  â”‚
â”‚  â”‚  â”‚ 47              â”‚                                                      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Execution Time: 0.023 seconds                                             â”‚  â”‚
â”‚  â”‚  Rows Returned: 1                                                          â”‚  â”‚
â”‚  â”‚  Status: âœ… SUCCESS                                                        â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 8: CONFIDENCE SCORING                                                 â”‚  â”‚
â”‚  â”‚ File: core/engine/confidence_scorer.py                                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Score Formula:                                                            â”‚  â”‚
â”‚  â”‚  TOTAL = (Dictionary Ã— 0.40) + (Metadata Ã— 0.30) +                        â”‚  â”‚
â”‚  â”‚          (Execution Ã— 0.20) + (Sanity Ã— 0.10)                             â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  DICTIONARY MATCH (40% weight)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ "headaches" â†’ "Headache" match score: 97.2%                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Weighted: 97.2% Ã— 0.40 = 38.9 points                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  METADATA COVERAGE (30% weight)                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Variables used: USUBJID, AEDECOD                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Both approved in golden_metadata: 100%                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Weighted: 100% Ã— 0.30 = 30.0 points                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  EXECUTION SUCCESS (20% weight)                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Query executed without error: âœ…                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Weighted: 100% Ã— 0.20 = 20.0 points                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  RESULT SANITY (10% weight)                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Row count reasonable (1 row for count query): âœ…                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ Value reasonable (47 < total subjects): âœ…                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Weighted: 100% Ã— 0.10 = 10.0 points                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  TOTAL CONFIDENCE: 98.9% â†’ ðŸŸ¢ GREEN (HIGH)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 9: EXPLANATION GENERATION                                             â”‚  â”‚
â”‚  â”‚ File: core/engine/explanation_generator.py                                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  Generate human-readable explanation:                                      â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ðŸ“Š RESULT: 47 patients                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Based on the Adverse Events (AE) dataset, 47 unique patients       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  reported headaches during the study.                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  METHODOLOGY:                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Searched the AEDECOD (Dictionary-Derived Term) column            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Matched adverse events containing "Headache"                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Counted distinct subject identifiers (USUBJID)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  CONFIDENCE: ðŸŸ¢ 98.9% (HIGH)                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  The term "headaches" matched "Headache" in the MedDRA-coded        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  adverse event dictionary with 97.2% confidence.                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  [Show SQL]  [Show Methodology]  [Export CSV]  [Ask Follow-up] â”‚ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                                       â”‚
â”‚                          â–¼                                                       â”‚
â”‚                   RESPONSE TO USER                                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DeepSeek-R1 LLM: The TRANSLATOR Role

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DEEPSEEK-R1 LLM ROLE                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  The AI is a TRANSLATOR, not an EXPERT                                          â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                                                         â”‚     â”‚
â”‚  â”‚  WHAT THE LLM DOES:                                                    â”‚     â”‚
â”‚  â”‚  âœ… Translate natural language â†’ SQL syntax                            â”‚     â”‚
â”‚  â”‚  âœ… Understand table/column context from provided schema               â”‚     â”‚
â”‚  â”‚  âœ… Apply proper SQL patterns (COUNT, JOIN, GROUP BY, etc.)           â”‚     â”‚
â”‚  â”‚  âœ… Use entity resolution hints (fuzzy match results)                  â”‚     â”‚
â”‚  â”‚                                                                         â”‚     â”‚
â”‚  â”‚  WHAT THE LLM DOES NOT DO:                                             â”‚     â”‚
â”‚  â”‚  âŒ Calculate statistics (that's DuckDB's job)                         â”‚     â”‚
â”‚  â”‚  âŒ Know the actual data values (it only sees schema)                  â”‚     â”‚
â”‚  â”‚  âŒ Make clinical judgments                                            â”‚     â”‚
â”‚  â”‚  âŒ Interpret results                                                   â”‚     â”‚
â”‚  â”‚                                                                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                  â”‚
â”‚  This ensures:                                                                   â”‚
â”‚  â€¢ Reproducible results (same SQL = same answer)                                â”‚
â”‚  â€¢ Auditable queries (SQL can be reviewed)                                      â”‚
â”‚  â€¢ Deterministic execution (no probabilistic math)                              â”‚
â”‚                                                                                  â”‚
â”‚  Model Configuration:                                                            â”‚
â”‚  â€¢ Primary: deepseek-r1:8b (or 14b for better quality)                          â”‚
â”‚  â€¢ Fallback: llama3.1:8b-instruct-q8_0                                          â”‚
â”‚  â€¢ Host: Ollama at http://ollama:11434                                          â”‚
â”‚  â€¢ Context Window: 32K tokens                                                   â”‚
â”‚                                                                                  â”‚
â”‚  Special Feature - Chain-of-Thought (<think> tags):                             â”‚
â”‚  DeepSeek-R1 shows its reasoning, enabling audit and debugging                  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### How Fuzzy Matching Helps (Factory 3 Integration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FUZZY MATCHING VALUE IN THE PIPELINE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  WITHOUT Factory 3 (Fuzzy Matching):                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  User: "How many patients had headches?"  (typo)                       â”‚     â”‚
â”‚  â”‚                                                                         â”‚     â”‚
â”‚  â”‚  LLM generates: WHERE AEDECOD = 'headches'                             â”‚     â”‚
â”‚  â”‚  Result: 0 patients (wrong!)                                           â”‚     â”‚
â”‚  â”‚                                                                         â”‚     â”‚
â”‚  â”‚  The LLM doesn't know actual values in the database                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                  â”‚
â”‚  WITH Factory 3 (Fuzzy Matching):                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  User: "How many patients had headches?"  (typo)                       â”‚     â”‚
â”‚  â”‚                     â”‚                                                   â”‚     â”‚
â”‚  â”‚                     â–¼                                                   â”‚     â”‚
â”‚  â”‚  Fuzzy Match: "headches" â†’ "Headache" (79.6% match)                    â”‚     â”‚
â”‚  â”‚                     â”‚                                                   â”‚     â”‚
â”‚  â”‚                     â–¼                                                   â”‚     â”‚
â”‚  â”‚  Prompt to LLM includes: "headches" resolved to AEDECOD='Headache'    â”‚     â”‚
â”‚  â”‚                     â”‚                                                   â”‚     â”‚
â”‚  â”‚                     â–¼                                                   â”‚     â”‚
â”‚  â”‚  LLM generates: WHERE AEDECOD ILIKE '%Headache%'                       â”‚     â”‚
â”‚  â”‚  Result: 47 patients (correct!)                                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                  â”‚
â”‚  Key Benefits:                                                                   â”‚
â”‚  â€¢ Typo tolerance (headches â†’ Headache)                                         â”‚
â”‚  â€¢ Case insensitivity (HEADACHE â†’ Headache)                                     â”‚
â”‚  â€¢ Synonym mapping via MedDRA (cephalgia â†’ Headache)                            â”‚
â”‚  â€¢ Column discovery (tells LLM which table.column has the value)                â”‚
â”‚  â€¢ Confidence contribution (fuzzy score â†’ overall confidence)                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Complete Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            COMPLETE DATA FLOW                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚                              USER                                                â”‚
â”‚                                â”‚                                                 â”‚
â”‚                                â–¼                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚      Chat UI          â”‚                                    â”‚
â”‚                    â”‚   (React Frontend)    â”‚                                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                â”‚ HTTP/SSE                                        â”‚
â”‚                                â–¼                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚     NGINX Gateway     â”‚                                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                â”‚                                                 â”‚
â”‚                                â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         FastAPI Backend                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                    /api/v1/chat/message                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚         â”‚                    â”‚                    â”‚                      â”‚   â”‚
â”‚  â”‚         â–¼                    â–¼                    â–¼                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Input       â”‚     â”‚ Fuzzy       â”‚     â”‚ Query       â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ Sanitizer   â”‚â”€â”€â”€â”€â–¶â”‚ Matcher     â”‚â”€â”€â”€â”€â–¶â”‚ Router      â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ (STEP 1)    â”‚     â”‚ (STEP 2)    â”‚     â”‚ (STEP 3)    â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                             â”‚                    â”‚                       â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                       â”‚   â”‚
â”‚  â”‚         â”‚  fuzzy_index.pkl                       â”‚                       â”‚   â”‚
â”‚  â”‚         â”‚  meddra_library.db                     â”‚                       â”‚   â”‚
â”‚  â”‚         â–¼                                        â–¼                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Metadata    â”‚â”€â”€â”€â”€â–¶â”‚ SQL         â”‚â”€â”€â”€â”€â–¶â”‚ SQL         â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ Retriever   â”‚     â”‚ Generator   â”‚     â”‚ Validator   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ (STEP 4)    â”‚     â”‚ (STEP 5)    â”‚     â”‚ (STEP 6)    â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚         â”‚                   â”‚                    â”‚                       â”‚   â”‚
â”‚  â”‚         â”‚  golden_          â”‚  Ollama            â”‚                       â”‚   â”‚
â”‚  â”‚         â”‚  metadata.json    â”‚  DeepSeek-R1       â”‚                       â”‚   â”‚
â”‚  â”‚         â–¼                   â–¼                    â–¼                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ SQL         â”‚â”€â”€â”€â”€â–¶â”‚ Confidence  â”‚â”€â”€â”€â”€â–¶â”‚ Explanation â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ Executor    â”‚     â”‚ Scorer      â”‚     â”‚ Generator   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ (STEP 7)    â”‚     â”‚ (STEP 8)    â”‚     â”‚ (STEP 9)    â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚         â”‚                                       â”‚                       â”‚   â”‚
â”‚  â”‚         â”‚  clinical_data.duckdb                 â”‚                       â”‚   â”‚
â”‚  â”‚         â–¼                                       â–¼                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                      SSE Response Stream                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  { "sql": "...", "results": [...], "confidence": 98.9,          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    "explanation": "47 patients had headaches..." }               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                                 â”‚
â”‚                                â–¼                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                    â”‚      Chat UI          â”‚                                    â”‚
â”‚                    â”‚   Display Results     â”‚                                    â”‚
â”‚                    â”‚   + Confidence        â”‚                                    â”‚
â”‚                    â”‚   + SQL (optional)    â”‚                                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Confidence Score Thresholds

| Score | Color | Meaning | User Action |
|-------|-------|---------|-------------|
| 90-100% | ðŸŸ¢ GREEN | High confidence | Trust result |
| 70-89% | ðŸŸ¡ YELLOW | Medium confidence | Verify assumptions |
| 50-69% | ðŸŸ  ORANGE | Low confidence | Review methodology |
| <50% | ðŸ”´ RED | Cannot provide reliable answer | Rephrase question |

### Confidence Score Components

| Component | Weight | What It Measures | Why It Matters |
|-----------|--------|------------------|----------------|
| **Dictionary Match** | 40% | Fuzzy match score for resolved entities | Misidentified terms = wrong answer |
| **Metadata Coverage** | 30% | % of SQL columns with approved definitions | Approved = human-verified understanding |
| **Execution Success** | 20% | Query ran without error | Syntax errors = generation problem |
| **Result Sanity** | 10% | Result values are reasonable | Catches logical errors |

### Module Architecture

```
core/engine/                          # Factory 4 - Inference Engine
â”œâ”€â”€ __init__.py                       # Module exports
â”œâ”€â”€ input_sanitizer.py                # STEP 1: Security filtering
â”œâ”€â”€ entity_extractor.py               # STEP 2: Term extraction + fuzzy matching
â”œâ”€â”€ router.py                         # STEP 3: Intent classification
â”œâ”€â”€ context_builder.py                # STEP 4: Metadata context assembly
â”œâ”€â”€ sql_generator.py                  # STEP 5: LLM prompt + SQL generation
â”œâ”€â”€ sql_validator.py                  # STEP 6: SQL parsing + validation
â”œâ”€â”€ executor.py                       # STEP 7: Sandboxed DuckDB execution
â”œâ”€â”€ confidence_scorer.py              # STEP 8: Composite scoring
â”œâ”€â”€ explanation_generator.py          # STEP 9: Human-readable output
â””â”€â”€ pipeline.py                       # Orchestrates all 9 steps
```

### Implementation Status

| Component | File | Status | Lines Est. |
|-----------|------|--------|------------|
| Chat Router | `docker/api/routers/chat.py` | âœ… Basic | 433 |
| Chat UI | `ChatPage.tsx`, `ChatContainer.tsx` | âœ… Complete | ~500 |
| LLM Integration | Ollama + DeepSeek-R1 | âœ… Working | - |
| Input Sanitizer | `core/engine/input_sanitizer.py` | â¬œ New | ~150 |
| Entity Extractor | `core/engine/entity_extractor.py` | â¬œ New | ~200 |
| Query Router | `core/engine/router.py` | â¬œ New | ~150 |
| Context Builder | `core/engine/context_builder.py` | â¬œ New | ~200 |
| SQL Generator | `core/engine/sql_generator.py` | â¬œ New | ~300 |
| SQL Validator | `core/engine/sql_validator.py` | â¬œ New | ~250 |
| Executor | `core/engine/executor.py` | â¬œ New | ~200 |
| Confidence Scorer | `core/engine/confidence_scorer.py` | â¬œ New | ~200 |
| Explanation Generator | `core/engine/explanation_generator.py` | â¬œ New | ~200 |
| Pipeline Orchestrator | `core/engine/pipeline.py` | â¬œ New | ~300 |

### Performance Targets

| Metric | Target |
|--------|--------|
| End-to-end query time | < 5 seconds |
| SQL generation (LLM) | < 3 seconds |
| SQL execution | < 1 second |
| Validation + scoring | < 500ms |
| Simple queries | < 2 seconds |

### Success Criteria

1. **Query Understanding:**
   - [ ] Typos corrected via fuzzy matching
   - [ ] Medical synonyms resolved via MedDRA
   - [ ] Intent correctly classified (DATA/DOCUMENT/HYBRID)

2. **SQL Generation:**
   - [ ] Valid DuckDB syntax generated
   - [ ] Correct tables and columns used
   - [ ] Entity resolution applied to WHERE clauses

3. **Security:**
   - [ ] SQL injection attempts blocked
   - [ ] Prompt injection attempts blocked
   - [ ] PHI/PII patterns detected and rejected
   - [ ] Only SELECT queries allowed

4. **Confidence Scoring:**
   - [ ] Accurate composite scores
   - [ ] Color-coded thresholds displayed
   - [ ] Score breakdown available

5. **User Experience:**
   - [ ] Results with explanations
   - [ ] SQL viewable on request
   - [ ] Export capability
   - [ ] Follow-up questions supported

---

## End-to-End Integration

### Critical: Data â†” Metadata Alignment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HOW ALL FACTORIES CONNECT                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  FACTORY 1 (Data)                    FACTORY 2 (Metadata)                      â”‚
â”‚  clinical_data.duckdb                golden_metadata.json                      â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Table: DM        â”‚                â”‚ Domain: DM       â”‚                      â”‚
â”‚  â”‚ â”œâ”€â”€ USUBJID      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚ â”œâ”€â”€ USUBJID      â”‚                      â”‚
â”‚  â”‚ â”œâ”€â”€ AGE          â”‚   Must Match   â”‚ â”œâ”€â”€ AGE          â”‚                      â”‚
â”‚  â”‚ â”œâ”€â”€ SEX          â”‚                â”‚ â”œâ”€â”€ SEX          â”‚                      â”‚
â”‚  â”‚ â””â”€â”€ RACE         â”‚                â”‚ â””â”€â”€ RACE         â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚                                   â”‚                                 â”‚
â”‚           â”‚                                   â”‚                                 â”‚
â”‚           â–¼                                   â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         FACTORY 3 (Dictionary)                           â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  Combines BOTH to build indexes:                                         â”‚   â”‚
â”‚  â”‚  â€¢ Actual values from DuckDB (HEADACHE, TYLENOL, GLUCOSE)               â”‚   â”‚
â”‚  â”‚  â€¢ Meanings from Metadata (what each column represents)                  â”‚   â”‚
â”‚  â”‚  â€¢ Embeddings for semantic search                                        â”‚   â”‚
â”‚  â”‚  â€¢ Fuzzy index for typo correction                                       â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                          â”‚
â”‚                                      â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         FACTORY 4 (Inference)                            â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  Uses ALL outputs:                                                       â”‚   â”‚
â”‚  â”‚  â€¢ Dictionary indexes to understand user query                          â”‚   â”‚
â”‚  â”‚  â€¢ Metadata to provide context to LLM                                   â”‚   â”‚
â”‚  â”‚  â€¢ DuckDB to execute generated SQL                                      â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  âš ï¸  VALIDATION REQUIREMENT:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Before Factory 3 can build indexes, we must validate:                 â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  1. Every table in DuckDB has a matching domain in golden_metadata     â”‚   â”‚
â”‚  â”‚  2. Every column in DuckDB tables has metadata definition              â”‚   â”‚
â”‚  â”‚  3. Data types are compatible                                          â”‚   â”‚
â”‚  â”‚  4. All required variables from metadata exist in actual data          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  MISMATCHES:                                                            â”‚   â”‚
â”‚  â”‚  â€¢ Data has column not in metadata â†’ Flag for review                   â”‚   â”‚
â”‚  â”‚  â€¢ Metadata has variable not in data â†’ Warning                         â”‚   â”‚
â”‚  â”‚  â€¢ Type mismatch â†’ May affect query generation                         â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  WHY THIS MATTERS FOR LLM:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  The LLM uses METADATA to understand what columns mean:                â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  â€¢ User asks: "Show me patient ages"                                   â”‚   â”‚
â”‚  â”‚  â€¢ LLM sees metadata: AGE = "Age in years at screening"                â”‚   â”‚
â”‚  â”‚  â€¢ LLM generates: SELECT AGE FROM DM                                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  If DATA has AGE but METADATA doesn't define it:                       â”‚   â”‚
â”‚  â”‚  â€¢ LLM won't know what AGE means                                       â”‚   â”‚
â”‚  â”‚  â€¢ Query confidence will be LOW                                        â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  If METADATA defines AGE but DATA doesn't have it:                     â”‚   â”‚
â”‚  â”‚  â€¢ LLM might reference AGE in SQL                                      â”‚   â”‚
â”‚  â”‚  â€¢ Query will FAIL at execution                                        â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Complete Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SAGE COMPLETE DATA FLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  DATA FILES                         SPEC FILES                                 â”‚
â”‚  dm.sas7bdat                        SDTM_spec.xlsx                             â”‚
â”‚  ae.parquet                         ADaM_spec.xlsx                             â”‚
â”‚  lb.csv                                   â”‚                                     â”‚
â”‚       â”‚                                   â”‚                                     â”‚
â”‚       â–¼                                   â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚  FACTORY 1  â”‚                   â”‚  FACTORY 2  â”‚                             â”‚
â”‚  â”‚    Data     â”‚                   â”‚  Metadata   â”‚                             â”‚
â”‚  â”‚   Foundry   â”‚                   â”‚  Refinery   â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚         â”‚                                 â”‚                                     â”‚
â”‚         â–¼                                 â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚clinical_dataâ”‚                   â”‚golden_meta- â”‚                             â”‚
â”‚  â”‚  .duckdb    â”‚                   â”‚  data.json  â”‚                             â”‚
â”‚  â”‚             â”‚                   â”‚             â”‚                             â”‚
â”‚  â”‚ â€¢ DM table  â”‚                   â”‚ â€¢ DM domain â”‚                             â”‚
â”‚  â”‚ â€¢ AE table  â”‚                   â”‚   - USUBJID â”‚                             â”‚
â”‚  â”‚ â€¢ LB table  â”‚                   â”‚   - AGE     â”‚                             â”‚
â”‚  â”‚ â€¢ 520 rows  â”‚                   â”‚   - SEX     â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚         â”‚                                 â”‚                                     â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚         â”‚         â”‚                                                             â”‚
â”‚         â–¼         â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚      FACTORY 3      â”‚                                                        â”‚
â”‚  â”‚   Dictionary Plant  â”‚                                                        â”‚
â”‚  â”‚                     â”‚                                                        â”‚
â”‚  â”‚ Combines data valuesâ”‚                                                        â”‚
â”‚  â”‚ with metadata       â”‚                                                        â”‚
â”‚  â”‚ definitions         â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚             â”‚                                                                   â”‚
â”‚             â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ â€¢ ChromaDB vectors  â”‚                                                        â”‚
â”‚  â”‚ â€¢ fuzzy_index.pkl   â”‚                                                        â”‚
â”‚  â”‚ â€¢ schema_map.json   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚             â”‚                                                                   â”‚
â”‚             â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚             â”‚     â”‚                                         â”‚                   â”‚
â”‚             â–¼     â–¼                                         â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          FACTORY 4: INFERENCE ENGINE                     â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  User: "How many patients had headaches?"                               â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚  1. Fuzzy Match: "headaches" â†’ HEADACHE (from ChromaDB/fuzzy_index)     â”‚   â”‚
â”‚  â”‚  2. Get Context: AE.AETERM definition (from golden_metadata.json)       â”‚   â”‚
â”‚  â”‚  3. Generate SQL: SELECT COUNT(DISTINCT USUBJID)... (DeepSeek-R1)       â”‚   â”‚
â”‚  â”‚  4. Execute: Run against clinical_data.duckdb                           â”‚   â”‚
â”‚  â”‚  5. Score: Calculate confidence (95%)                                   â”‚   â”‚
â”‚  â”‚  6. Explain: "47 patients reported headaches..."                        â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Admin UI & Infrastructure

### Current React UI Status: âœ… COMPLETE

| Page | Route | Status |
|------|-------|--------|
| Login | `/login` | âœ… Complete |
| Dashboard | `/dashboard` | âœ… Complete |
| Chat | `/chat` | âœ… Complete |
| Data Management | `/data` | ðŸ”„ Basic (needs enhancement) |
| Metadata Auditor | `/metadata` | âœ… Complete |
| CDISC Library | `/cdisc-library` | âœ… Complete |
| Dictionary Manager | `/dictionary` | â¬œ Placeholder |
| User Management | `/users` | âœ… Complete |
| Audit Logs | `/audit` | âœ… Complete |
| Project Tracker | `/tracker` | âœ… Complete |
| Settings | `/settings` | âœ… Complete |

### Docker Services

| Service | Port | Status |
|---------|------|--------|
| nginx | 80 | âœ… Running |
| admin-ui-react | 3000 | âœ… Running |
| api | 8000 | âœ… Running |
| ollama | 11434 | âœ… Running |
| chromadb | 8001 | âœ… Running |
| docs | 8080 | âœ… Available |

---

## Implementation Checklists

### Factory 1: Data Foundry Checklist

#### 1.1 Core Backend - Universal Data Reader
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.1.1 | Create `core/data/universal_reader.py` - unified reader | High | âœ… Complete |
| 1.1.2 | Add CSV reader with delimiter detection | High | âœ… Complete |
| 1.1.3 | Add XPT (SAS Transport) file support | Medium | âœ… Complete |
| 1.1.4 | Implement format auto-detection | High | âœ… Complete |
| 1.1.5 | Standardize table naming (stem â†’ uppercase) | High | âœ… Complete |

#### 1.2 Backend API - Real Processing Pipeline
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.2.1 | Rewrite `/process` endpoint for real processing | Critical | âœ… Complete |
| 1.2.2 | Add SSE streaming `/process/stream/{filename}` | Critical | âœ… Complete |
| 1.2.3 | Implement background job queue | High | âœ… Complete |
| 1.2.4 | Add file status tracking (pending/processing/loaded) | High | âœ… Complete |
| 1.2.5 | Add `/files/{filename}/process` single file | High | âœ… Complete |
| 1.2.6 | Fix `/query` JSON body handling | Medium | âœ… Complete |
| 1.2.7 | Add real `/validation/{table}` data | Medium | âœ… Complete |
| 1.2.8 | Add `/tables/{table}/statistics` | Low | â¬œ |
| 1.2.9 | Add export endpoints (CSV, Parquet) | Medium | âœ… Complete |
| 1.2.10 | Add DELETE `/tables/{table}` endpoint | Medium | âœ… Complete |

#### 1.3 Data Versioning
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.3.1 | Create schema_versions SQLite table | High | âœ… Complete |
| 1.3.2 | Calculate schema hash for comparison | High | âœ… Complete |
| 1.3.3 | Detect and log schema changes | High | âœ… Complete |
| 1.3.4 | Add confirmation for breaking changes | High | âœ… Complete |
| 1.3.5 | Store previous schema versions | Medium | âœ… Complete |
| 1.3.6 | Add UI version history per table | Medium | âœ… Complete |
| 1.3.7 | Add schema comparison UI (visual diff) | Medium | âœ… Complete |
| 1.3.8 | Add schema rollback functionality | Medium | âœ… Complete |

#### 1.4 Source Files Management
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.4.1 | Track file status persistently (FileStore) | High | âœ… Complete |
| 1.4.2 | Store file metadata (name, size, format, status) | High | âœ… Complete |
| 1.4.3 | Link source files to tables | High | âœ… Complete |
| 1.4.4 | Support batch upload | Medium | âœ… Complete |
| 1.4.5 | Add file validation before processing | Medium | âœ… Complete |
| 1.4.6 | File history tracking with processing steps | Medium | âœ… Complete |

#### 1.5 Frontend - Data Foundry Page
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.5.1 | Create `DataFoundryPage.tsx` | High | âœ… Complete |
| 1.5.2 | Source Files Tab - list with status | High | âœ… Complete |
| 1.5.3 | Source Files Tab - drag-drop upload | High | âœ… Complete |
| 1.5.4 | Source Files Tab - format icons | Medium | âœ… Complete |
| 1.5.5 | Source Files Tab - process button | High | âœ… Complete |
| 1.5.6 | Processing Tab - SSE progress | Critical | âœ… Complete |
| 1.5.7 | Processing Tab - per-file progress | High | âœ… Complete |
| 1.5.8 | Tables Tab - list with counts | High | âœ… Complete |
| 1.5.9 | Tables Tab - preview (paginated) | High | âœ… Complete |
| 1.5.10 | Tables Tab - schema view | Medium | âœ… Complete |
| 1.5.11 | Tables Tab - export (CSV + Parquet) | Medium | âœ… Complete |
| 1.5.12 | Tables Tab - delete with confirmation | Medium | âœ… Complete |
| 1.5.13 | Validation Tab - quality scores | Medium | âœ… Complete |
| 1.5.14 | Schema Tab - version history | Medium | âœ… Complete |
| 1.5.15 | Schema Tab - version comparison diff | Medium | âœ… Complete |
| 1.5.16 | Schema Tab - rollback to version | Medium | âœ… Complete |
| 1.5.17 | History Tab - file processing history | Medium | âœ… Complete |
| 1.5.18 | Query Tab - SQL editor | Low | â¬œ |

#### 1.6 Data-Metadata Integration
| # | Task | Priority | Status |
|---|------|----------|--------|
| 1.6.1 | Create `/validate/alignment` endpoint | High | â¬œ |
| 1.6.2 | Compare DuckDB vs metadata domains | High | â¬œ |
| 1.6.3 | Report missing/extra tables | High | â¬œ |
| 1.6.4 | Report column mismatches | High | â¬œ |
| 1.6.5 | Add alignment status dashboard | Medium | â¬œ |
| 1.6.6 | Block Factory 3 if misaligned | High | â¬œ |

### Factory 2: Metadata Refinery Checklist

| # | Task | Status |
|---|------|--------|
| 2.1 | Excel parser for SDTM/ADaM specs | âœ… Complete |
| 2.2 | Codelist merger | âœ… Complete |
| 2.3 | LLM drafter for descriptions | âœ… Complete |
| 2.4 | Metadata store with JSON persistence | âœ… Complete |
| 2.5 | Version control with SQLite | âœ… Complete |
| 2.6 | CDISC Library (2352 standard vars) | âœ… Complete |
| 2.7 | Auto-approval engine | âœ… Complete |
| 2.8 | Admin UI - Metadata Auditor | âœ… Complete |
| 2.9 | Admin UI - CDISC Browser | âœ… Complete |
| 2.10 | Bulk approve (single version) | âœ… Complete |
| 2.11 | Version restore | âœ… Complete |
| 2.12 | Export functionality | âœ… Complete |

### Factory 3: Dictionary Plant Checklist âœ… COMPLETE

#### 3.1 Core Module Structure
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.1.1 | Create `core/dictionary/` directory | High | âœ… |
| 3.1.2 | Create `__init__.py` with exports | High | âœ… |
| 3.1.3 | Add `rapidfuzz` to requirements.txt | High | âœ… |

#### 3.2 Value Scanner (`value_scanner.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.2.1 | Create ValueScanner class | High | âœ… |
| 3.2.2 | Implement `scan_table()` method | High | âœ… |
| 3.2.3 | Implement `scan_all_tables()` method | High | âœ… |
| 3.2.4 | Implement `get_scannable_columns()` | High | âœ… |
| 3.2.5 | Add cardinality threshold (skip high-cardinality) | Medium | âœ… |
| 3.2.6 | Add progress callback for UI | Medium | âœ… |
| 3.2.7 | Exclude AETERM/free text columns | High | âœ… |
| 3.2.8 | Exclude flag columns (Y/N values) | High | âœ… |

#### 3.3 Embedding Generator - REMOVED BY DESIGN
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.3.x | *Removed - Clinical data uses MedDRA controlled vocabulary* | - | âŒ N/A |

#### 3.4 ChromaDB Store - REMOVED BY DESIGN
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.4.x | *Removed - MedDRA hierarchy handles synonyms* | - | âŒ N/A |

#### 3.5 Fuzzy Matcher (`fuzzy_matcher.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.5.1 | Create FuzzyMatcher class | High | âœ… |
| 3.5.2 | Create FuzzyMatch dataclass | High | âœ… |
| 3.5.3 | Implement `build_index()` from values dict | High | âœ… |
| 3.5.4 | Implement `match()` with RapidFuzz | High | âœ… |
| 3.5.5 | Add smart scoring (ratio, token_sort, token_set, partial) | High | âœ… |
| 3.5.6 | Implement `match_in_column()` | Medium | âœ… |
| 3.5.7 | Implement `save()` and `load()` for pickle | High | âœ… |
| 3.5.8 | Add length ratio filtering (prevent false positives) | High | âœ… |
| 3.5.9 | Add excluded values set (Y, N, NA, etc.) | High | âœ… |
| 3.5.10 | Add code column exclusion | High | âœ… |

#### 3.6 Term Resolver (`term_resolver.py`) - Replaces HybridMatcher
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.6.1 | Create TermResolver class | High | âœ… |
| 3.6.2 | Integrate FuzzyMatcher | High | âœ… |
| 3.6.3 | Integrate MedDRA library | High | âœ… |
| 3.6.4 | Combined lookup (fuzzy + MedDRA) | High | âœ… |
| 3.6.5 | Standardize term resolution | High | âœ… |

#### 3.7 Schema Mapper (`schema_mapper.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.7.1 | Create SchemaMapper class | High | âœ… |
| 3.7.2 | Generate columns mapping | High | âœ… |
| 3.7.3 | Generate tables mapping | High | âœ… |
| 3.7.4 | Add statistics summary | Medium | âœ… |
| 3.7.5 | Save to `knowledge/schema_map.json` | High | âœ… |

#### 3.8 CLI Pipeline (`scripts/factory3_dictionary.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.8.1 | Create CLI script structure | High | âœ… |
| 3.8.2 | Verify Factory 1 prerequisites | High | âœ… |
| 3.8.3 | Implement value scanning step | High | âœ… |
| 3.8.4 | Implement fuzzy index build step | High | âœ… |
| 3.8.5 | Implement schema map generation step | High | âœ… |
| 3.8.6 | Add `--rebuild` flag | Medium | âœ… |
| 3.8.7 | Add `--table` filter option | Medium | âœ… |
| 3.8.8 | Add `--stats` summary option | Low | âœ… |
| 3.8.9 | Add `--test` option for fuzzy matching test | Medium | âœ… |

#### 3.9 API Router (`docker/api/routers/dictionary.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.9.1 | Create router with prefix `/api/v1/dictionary` | High | âœ… |
| 3.9.2 | Add `GET /status` endpoint | High | âœ… |
| 3.9.3 | Add `POST /build` endpoint (admin) | High | âœ… |
| 3.9.4 | Add `POST /search` endpoint | High | âœ… |
| 3.9.5 | Add `GET /tables` endpoint | Medium | âœ… |
| 3.9.6 | Add `GET /values/{table}/{column}` endpoint | Medium | âœ… |
| 3.9.7 | Add `GET /schema-map` endpoint | Medium | âœ… |
| 3.9.8 | Add `GET /statistics` endpoint | Medium | âœ… |
| 3.9.9 | Add `POST /lookup` endpoint (fuzzy + MedDRA) | High | âœ… |
| 3.9.10 | Add `POST /correct` endpoint (spelling correction) | Medium | âœ… |
| 3.9.11 | Add `POST /resolve` endpoint (term resolver) | High | âœ… |
| 3.9.12 | Add progress tracking for builds | Medium | âœ… |
| 3.9.13 | Register router in main.py | High | âœ… |

#### 3.10 Admin UI (`DictionaryManagerPage.tsx`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.10.1 | Create page structure with tabs | High | âœ… |
| 3.10.2 | Status tab - build info, statistics | High | âœ… |
| 3.10.3 | Search tab - interactive search testing | High | âœ… |
| 3.10.4 | Values tab - browse by table/column | Medium | âœ… |
| 3.10.5 | Rebuild tab - trigger with progress bar | Medium | âœ… |
| 3.10.6 | Add API client methods to `dictionary.ts` | High | âœ… |

#### 3.11 Testing & Validation
| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.11.1 | Test "headche" â†’ "Headache" (79.6%) | High | âœ… |
| 3.11.2 | Test "hypertention" â†’ "Hypertension" (83.7%) | High | âœ… |
| 3.11.3 | Test "nausea" â†’ exact match (100%) | High | âœ… |
| 3.11.4 | Test TYLENOL â†’ no false positives (Y/N) | High | âœ… |
| 3.11.5 | Verify index size (~15K entries filtered) | Medium | âœ… |
| 3.11.6 | Verify build time (~1 second) | Medium | âœ… |

### Factory 3.5: MedDRA Library Checklist âœ… COMPLETE

| # | Task | Priority | Status |
|---|------|----------|--------|
| 3.5.1 | Create `core/meddra/` directory | High | âœ… |
| 3.5.2 | MedDRA ASCII file loader | High | âœ… |
| 3.5.3 | MedDRA SQLite database | High | âœ… |
| 3.5.4 | Hierarchy navigation (PTâ†’HLTâ†’HLGTâ†’SOC) | High | âœ… |
| 3.5.5 | PT lookup by name | High | âœ… |
| 3.5.6 | API endpoints (`/api/v1/meddra/*`) | High | âœ… |
| 3.5.7 | Admin UI MedDRA Manager page | High | âœ… |
| 3.5.8 | File upload interface | High | âœ… |
| 3.5.9 | Hierarchy browser | Medium | âœ… |
| 3.5.10 | Search functionality | High | âœ… |

### Factory 4: Inference Engine Checklist

#### 4.1 Core Module Structure
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.1.1 | Create `core/engine/` directory | High | âœ… |
| 4.1.2 | Create `__init__.py` with exports | High | âœ… |
| 4.1.3 | Define common models/dataclasses | High | âœ… |

#### 4.1.5 Clinical Rules Engine (`clinical_config.py`, `table_resolver.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.1.5.1 | Create ClinicalConfig dataclass with default rules | Critical | âœ… |
| 4.1.5.2 | Define TablePriority (ADaM > SDTM) mappings | Critical | âœ… |
| 4.1.5.3 | Define ColumnPriority (ATOXGR > AETOXGR) mappings | Critical | âœ… |
| 4.1.5.4 | Define PopulationType enum (SAFETY, ITT, EFFICACY) | Critical | âœ… |
| 4.1.5.5 | Define population keywords mapping | Critical | âœ… |
| 4.1.5.6 | Define safety indicators set | Critical | âœ… |
| 4.1.5.7 | Create TableResolver class | Critical | âœ… |
| 4.1.5.8 | Implement resolve_table() - detect domain from query | Critical | âœ… |
| 4.1.5.9 | Implement _detect_population() - from query keywords | Critical | âœ… |
| 4.1.5.10 | Implement _get_population_filter() - return SQL filter | Critical | âœ… |
| 4.1.5.11 | Implement _resolve_columns() - prioritize analysis cols | Critical | âœ… |
| 4.1.5.12 | Return TableResolution with full transparency | Critical | âœ… |

#### 4.1.6 Response Builder (`explanation_generator.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.1.6.1 | Create QueryMethodology dataclass | High | âœ… |
| 4.1.6.2 | Create QueryResponse dataclass | High | âœ… |
| 4.1.6.3 | Implement to_markdown() for methodology | High | âœ… |
| 4.1.6.4 | Include table used, population, columns, assumptions | High | âœ… |
| 4.1.6.5 | Include SQL query in collapsible section | High | âœ… |

#### 4.2 Input Sanitizer (`input_sanitizer.py`) - STEP 1
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.2.1 | Create InputSanitizer class | High | âœ… |
| 4.2.2 | Implement PHI/PII pattern detection | High | âœ… |
| 4.2.3 | Implement SQL injection detection | High | âœ… |
| 4.2.4 | Implement prompt injection detection | High | âœ… |
| 4.2.5 | Add configurable blocklist patterns | Medium | âœ… |
| 4.2.6 | Return sanitized query or rejection reason | High | âœ… |

#### 4.3 Entity Extractor (`entity_extractor.py`) - STEP 2
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.3.1 | Create EntityExtractor class | High | âœ… |
| 4.3.2 | Integrate with FuzzyMatcher (Factory 3) | High | âœ… |
| 4.3.3 | Integrate with MedDRA library (Factory 3.5) | High | âœ… |
| 4.3.4 | Extract clinical terms from query | High | âœ… |
| 4.3.5 | Return resolved entities with confidence | High | âœ… |
| 4.3.6 | Include table.column location hints | High | âœ… |

#### 4.4 Query Router (handled by `table_resolver.py`) - STEP 3
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.4.1 | Create QueryRouter class (merged into TableResolver) | High | âœ… |
| 4.4.2 | Implement DATA intent detection | High | âœ… |
| 4.4.3 | Implement DOCUMENT intent detection | Medium | âœ… |
| 4.4.4 | Implement HYBRID intent detection | Medium | âœ… |
| 4.4.5 | Return RouteDecision with confidence | High | âœ… |

#### 4.5 Context Builder (`context_builder.py`) - STEP 4
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.5.1 | Create ContextBuilder class | High | âœ… |
| 4.5.2 | Load relevant metadata from golden_metadata.json | High | âœ… |
| 4.5.3 | Build schema context string for LLM | High | âœ… |
| 4.5.4 | Include entity resolution hints | High | âœ… |
| 4.5.5 | Optimize token usage (only relevant tables) | Medium | âœ… |

#### 4.6 SQL Generator (`sql_generator.py`) - STEP 5
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.6.1 | Create SQLGenerator class | High | âœ… |
| 4.6.2 | Build system prompt for DeepSeek-R1 | High | âœ… |
| 4.6.3 | Implement Ollama API integration | High | âœ… |
| 4.6.4 | Parse LLM response, extract SQL | High | âœ… |
| 4.6.5 | Handle `<think>` tags from DeepSeek-R1 | High | âœ… |
| 4.6.6 | Implement retry logic on failure | Medium | âœ… |
| 4.6.7 | Support fallback model (LLaMA) | Medium | âœ… |
| 4.6.8 | Stream response for UI feedback | Medium | â¬œ |

#### 4.7 SQL Validator (`sql_validator.py`) - STEP 6
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.7.1 | Create SQLValidator class | High | âœ… |
| 4.7.2 | Parse SQL syntax (use DuckDB parser) | High | âœ… |
| 4.7.3 | Verify all tables exist in schema | High | âœ… |
| 4.7.4 | Verify all columns exist in tables | High | âœ… |
| 4.7.5 | Block dangerous operations (DELETE, UPDATE, DROP) | High | âœ… |
| 4.7.6 | Detect SQL injection patterns | High | âœ… |
| 4.7.7 | Return validation result with issues | High | âœ… |

#### 4.8 Executor (`executor.py`) - STEP 7
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.8.1 | Create SQLExecutor class | High | âœ… |
| 4.8.2 | Connect to DuckDB in READ-ONLY mode | High | âœ… |
| 4.8.3 | Implement timeout (30 seconds) | High | âœ… |
| 4.8.4 | Execute SQL and capture results | High | âœ… |
| 4.8.5 | Convert results to DataFrame/JSON | High | âœ… |
| 4.8.6 | Capture execution time | High | âœ… |
| 4.8.7 | Handle errors gracefully | High | âœ… |

#### 4.9 Confidence Scorer (`confidence_scorer.py`) - STEP 8
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.9.1 | Create ConfidenceScorer class | High | âœ… |
| 4.9.2 | Implement Dictionary Match component (40%) | High | âœ… |
| 4.9.3 | Implement Metadata Coverage component (30%) | High | âœ… |
| 4.9.4 | Implement Execution Success component (20%) | High | âœ… |
| 4.9.5 | Implement Result Sanity component (10%) | High | âœ… |
| 4.9.6 | Calculate composite score (0-100) | High | âœ… |
| 4.9.7 | Assign color threshold (HIGH/MEDIUM/LOW/VERY_LOW) | High | âœ… |
| 4.9.8 | Return detailed score breakdown | High | âœ… |

#### 4.10 Explanation Generator (`explanation_generator.py`) - STEP 9
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.10.1 | Create ExplanationGenerator class | High | âœ… |
| 4.10.2 | Generate result summary in plain English | High | âœ… |
| 4.10.3 | Include methodology description | High | âœ… |
| 4.10.4 | Include confidence score with color | High | âœ… |
| 4.10.5 | Include entity resolution details | Medium | âœ… |
| 4.10.6 | Format for Chat UI display | High | âœ… |

#### 4.11 Pipeline Orchestrator (`pipeline.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.11.1 | Create InferencePipeline class | High | âœ… |
| 4.11.2 | Wire all 9 steps in sequence | High | âœ… |
| 4.11.3 | Implement SSE streaming for real-time feedback | High | â¬œ |
| 4.11.4 | Handle errors at each step gracefully | High | âœ… |
| 4.11.5 | Return complete PipelineResult | High | âœ… |

#### 4.12 Chat Router Enhancement (`docker/api/routers/chat.py`)
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.12.1 | Integrate InferencePipeline | High | â¬œ |
| 4.12.2 | Stream pipeline stages via SSE | High | â¬œ |
| 4.12.3 | Return structured response with SQL, results, confidence | High | â¬œ |
| 4.12.4 | Add conversation context support | Medium | â¬œ |
| 4.12.5 | Implement follow-up question handling | Medium | â¬œ |

#### 4.13 Chat UI Enhancements
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.13.1 | Display confidence score with color | High | â¬œ |
| 4.13.2 | Show/hide SQL toggle | High | â¬œ |
| 4.13.3 | Display tabular results | High | â¬œ |
| 4.13.4 | Add export to CSV button | Medium | â¬œ |
| 4.13.5 | Show methodology on request | Medium | â¬œ |
| 4.13.6 | Display streaming progress indicators | Medium | â¬œ |

#### 4.14 Testing & Validation
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.14.1 | Test: "How many patients?" (simple count) | High | âœ… |
| 4.14.2 | Test: "Patients with headaches" (fuzzy match) | High | âœ… |
| 4.14.3 | Test: "headches" (typo correction) | High | â¬œ |
| 4.14.4 | Test: Multi-table join (AE + DM) | High | â¬œ |
| 4.14.5 | Test: SQL injection blocked | High | âœ… |
| 4.14.6 | Test: Prompt injection blocked | High | âœ… |
| 4.14.7 | Test: Confidence scoring accuracy | High | âœ… |
| 4.14.8 | Test: Explanation quality | Medium | âœ… |
| 4.14.9 | Performance: < 5 seconds end-to-end | High | â¬œ |

#### 4.15 Audit & Logging
| # | Task | Priority | Status |
|---|------|----------|--------|
| 4.15.1 | Log all queries with timestamps | Medium | â¬œ |
| 4.15.2 | Log generated SQL | Medium | â¬œ |
| 4.15.3 | Log confidence scores | Medium | â¬œ |
| 4.15.4 | Log execution times | Medium | â¬œ |
| 4.15.5 | Log blocked queries (security) | High | â¬œ |

---

## Project Status Summary

### Overall Progress

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SAGE IMPLEMENTATION STATUS                        â”‚
â”‚                        Last Updated: December 2024                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Factory 1: Data Foundry          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  95% âœ“          â”‚
â”‚  â”œâ”€â”€ Core modules                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ API endpoints                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Data versioning              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Schema comparison/rollback   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Export (CSV + Parquet)       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Delete table                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ UI (6 tabs complete)         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â””â”€â”€ Data-Metadata alignment      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%            â”‚
â”‚                                                                         â”‚
â”‚  Factory 2: Metadata Refinery     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Excel parser                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ CDISC library                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Auto-approval                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â””â”€â”€ Admin UI                     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚                                                                         â”‚
â”‚  Factory 3: Dictionary Plant      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Value scanner                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Fuzzy matcher (RapidFuzz)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Schema mapper                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Term resolver                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â””â”€â”€ Admin UI (5 tabs)            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚                                                                         â”‚
â”‚  Factory 3.5: MedDRA Library      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ ASCII file loader            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ SQLite database              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ Hierarchy navigation         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â””â”€â”€ Admin UI                     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚                                                                         â”‚
â”‚  Factory 4: Inference Engine      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Clinical Rules Engine        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Input Sanitizer              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Entity Extractor             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Context Builder              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ SQL Generator                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ SQL Validator                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Executor                     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Confidence Scorer            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Explanation Generator        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Pipeline Orchestrator        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Unit Tests (194 passing)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Chat Router Integration      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Chat UI Enhancements         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Audit Logging                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ E2E Tests (51 passing)       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â””â”€â”€ Factory 3/3.5 Integration    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚                                                                         â”‚
â”‚  Infrastructure                   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“         â”‚
â”‚  â”œâ”€â”€ Docker Compose               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ NGINX Gateway                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â”œâ”€â”€ React Admin UI               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚  â””â”€â”€ Authentication               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%           â”‚
â”‚                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  OVERALL PROGRESS                 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  99%  âœ“         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Next Steps (Priority Order)

1. **Production Deployment** - Deploy and test with real clinical data
   - Load actual SAS7BDAT files through Factory 1
   - Build fuzzy index through Factory 3
   - Test natural language queries end-to-end
2. **Data-Metadata Alignment** - Optional validation enhancement
3. **Performance Optimization** - Query caching, connection pooling

### Files Summary

| Category | Count | Status |
|----------|-------|--------|
| Core Python Modules | 35+ | All complete (Factory 1-4) |
| Factory 4 Engine Modules | 12 | All complete (pipeline, clinical_config, etc.) |
| API Routers | 9 | All complete (including pipeline endpoints) |
| React Pages | 12 | All complete (including Dictionary Manager, MedDRA Manager) |
| Docker Services | 8 | All running |
| Factory 4 Tests | 194 | All passing (unit + E2E) |
| Documentation | This file | Complete |

---

## Appendix: Directory Structure

```
SAGE/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env
â”œâ”€â”€ CLAUDE.md
â”‚
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ nginx/nginx.conf
â”‚   â”œâ”€â”€ admin-ui-react/          # React frontend
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ metadata-auditor/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ data-management/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â”œâ”€â”€ api/                     # FastAPI backend
â”‚   â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â”œâ”€â”€ data.py
â”‚   â”‚   â”‚   â”œâ”€â”€ metadata.py
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ Dockerfile
â”‚   â””â”€â”€ ollama/
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ sas_reader.py        âœ…
â”‚   â”‚   â”œâ”€â”€ date_handler.py      âœ…
â”‚   â”‚   â”œâ”€â”€ duckdb_loader.py     âœ…
â”‚   â”‚   â”œâ”€â”€ universal_reader.py  â¬œ NEW
â”‚   â”‚   â””â”€â”€ schema_tracker.py    â¬œ NEW
â”‚   â”œâ”€â”€ metadata/
â”‚   â”‚   â”œâ”€â”€ excel_parser.py      âœ…
â”‚   â”‚   â”œâ”€â”€ metadata_store.py    âœ…
â”‚   â”‚   â”œâ”€â”€ version_control.py   âœ…
â”‚   â”‚   â”œâ”€â”€ cdisc_library.py     âœ…
â”‚   â”‚   â””â”€â”€ auto_approval.py     âœ…
â”‚   â”œâ”€â”€ dictionary/              â¬œ NEW
â”‚   â”‚   â”œâ”€â”€ value_scanner.py
â”‚   â”‚   â”œâ”€â”€ embedding_generator.py
â”‚   â”‚   â”œâ”€â”€ fuzzy_matcher.py
â”‚   â”‚   â””â”€â”€ hybrid_matcher.py
â”‚   â””â”€â”€ engine/                  â¬œ NEW
â”‚       â”œâ”€â”€ router.py
â”‚       â”œâ”€â”€ sql_generator.py
â”‚       â”œâ”€â”€ sql_validator.py
â”‚       â”œâ”€â”€ executor.py
â”‚       â”œâ”€â”€ confidence_scorer.py
â”‚       â””â”€â”€ explanation_generator.py
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ factory1_data.py         âœ…
â”‚   â”œâ”€â”€ factory2_metadata.py     âœ…
â”‚   â”œâ”€â”€ factory3_dictionary.py   â¬œ NEW
â”‚   â””â”€â”€ init_cdisc_library.py    âœ…
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                     # Upload SAS/Parquet/CSV here
â”‚   â”œâ”€â”€ processed/               # Parquet output
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ clinical.duckdb      # Main database
â”‚
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ golden_metadata.json     # Approved metadata
â”‚   â”œâ”€â”€ cdisc_library.db         # CDISC standards
â”‚   â”œâ”€â”€ metadata_versions.db     # Version history
â”‚   â””â”€â”€ chroma/                  # Vector store (F3)
â”‚
â”œâ”€â”€ tracker/
â”‚   â””â”€â”€ project_tracker.db       # Project tracking
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ IMPLEMENTATION_PLAN.md   # This file
    â””â”€â”€ ...
```

---

*This document is the single source of truth for SAGE platform implementation. Last updated: December 2024*
